{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <div class="section-header">
        <h1 class="section-title">üìÖ –ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h1>
        <p class="section-subtitle">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</p>
    </div>
    
    <div id="myEventsContent">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
</div>

<script>
fetch('/api/events/my/', {
    headers: {
        'X-CSRFToken': getCookie('csrftoken')
    }
})
.then(response => {
    if (!response.ok) {
        return response.json().then(err => Promise.reject(err));
    }
    return response.json();
})
.then(data => {
    const container = document.getElementById('myEventsContent');
    
    if (!data.events || data.events.length === 0) {
        container.innerHTML = `
            <div class="card">
                <div class="card-body" style="text-align: center; padding: 3rem;">
                    <p style="color: var(--text-light); font-size: 1.1rem;">–í—ã –ø–æ–∫–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∏ –Ω–∞ –æ–¥–Ω–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</p>
                    <a href="{% url 'frontend-events' %}" class="btn btn-primary" style="margin-top: 1rem;">–ù–∞–π—Ç–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 1.5rem;">';
    
    data.events.forEach(item => {
        const event = item.event;
        const reg = item.registration;
        if (!event || !reg) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        const date = event.start_date ? new Date(event.start_date) : null;
        const regType = reg.registration_type || 'athlete';
        
        html += `
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">${escapeHtml(event.name || event.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h2>
                    <span class="badge" style="background: ${regType === 'coach' ? '#ff9800' : 'var(--primary-blue)'}; color: white;">
                        ${regType === 'coach' ? 'üë®‚Äçüè´ –¢—Ä–µ–Ω–µ—Ä' : 'üèÉ –°–ø–æ—Ä—Ç—Å–º–µ–Ω'}
                    </span>
                </div>
                <div class="card-body">
                    ${date ? `<p><strong>–î–∞—Ç–∞:</strong> ${date.toLocaleDateString('ru-RU')}</p>` : ''}
                    ${event.city ? `<p><strong>–ì–æ—Ä–æ–¥:</strong> ${escapeHtml(event.city)}</p>` : ''}
                    <div style="margin-top: 1rem;">
                        <a href="/events/${event.id}/registered/" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
})
.catch(error => {
    console.error('–û—à–∏–±–∫–∞:', error);
    const errorMsg = error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
    document.getElementById('myEventsContent').innerHTML = `
        <div class="card">
            <div class="card-body">
                <p style="color: var(--error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${escapeHtml(errorMsg)}</p>
                <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 0.5rem;">
                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
                </p>
            </div>
        </div>
    `;
});

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
