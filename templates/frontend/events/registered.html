{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ—ë —É—á–∞—Å—Ç–∏–µ –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <div id="eventRegisteredContent">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
</div>

<script>
const eventId = {{ event_id }};
let eventData = null;
let registrationData = null;
let participantsData = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
Promise.all([
    fetch(`/api/events/${eventId}/`).then(r => r.json()),
    fetch(`/api/events/${eventId}/check-registration/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    }).then(r => r.json()),
    fetch(`/api/events/${eventId}/participants/`).then(r => r.json())
])
.then(([event, registration, participants]) => {
    eventData = event;
    registrationData = registration;
    participantsData = participants.participants || [];
    renderRegisteredView();
})
.catch(error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    document.getElementById('eventRegisteredContent').innerHTML = `
        <div class="card">
            <div class="card-body">
                <h2>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h2>
                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏.</p>
                <a href="{% url 'frontend-events' %}" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</a>
            </div>
        </div>
    `;
});

function renderRegisteredView() {
    const container = document.getElementById('eventRegisteredContent');
    
    if (!registrationData.is_registered) {
        container.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h2>–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</h2>
                    <p>–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ.</p>
                    <a href="/events/${eventId}/" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é</a>
                </div>
            </div>
        `;
        return;
    }
    
    const startDate = new Date(eventData.start_date);
    const now = new Date();
    const timeLeft = startDate - now;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã
    const ageGroupsText = eventData.age_groups && eventData.age_groups.length > 0
        ? eventData.age_groups.map(ag => {
            if (ag.min_age === ag.max_age) {
                return ag.min_age + ' –ª–µ—Ç';
            } else {
                return ag.min_age + '-' + ag.max_age + ' –ª–µ—Ç';
            }
        }).join(', ')
        : '–ù–µ —É–∫–∞–∑–∞–Ω—ã';
    
    const html = `
        <div style="margin-bottom: 1rem;">
            <a href="{% url 'frontend-events' %}" style="color: var(--primary-blue); text-decoration: none;">
                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
            </a>
        </div>
        
        <!-- –û—Ç—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –Ω–∞—á–∞–ª–∞ -->
        <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%); color: white;">
            <div class="card-body" style="text-align: center; padding: 2rem;">
                <h2 style="color: white; margin-bottom: 1rem;">‚è∞ –î–æ –Ω–∞—á–∞–ª–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
                <div id="countdown" style="font-size: 2rem; font-weight: bold; margin: 1rem 0;">
                    <div class="loading" style="margin: 1rem auto; display: block;"></div>
                </div>
                <p style="color: rgba(255, 255, 255, 0.9); margin-top: 1rem;">
                    ${startDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })} –≤ 
                    ${startDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
                </p>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <h2 class="card-title">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</h2>
            </div>
            <div class="card-body">
                <div class="profile-info">
                    <div class="profile-item">
                        <span class="profile-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                        <span class="profile-value">${escapeHtml(eventData.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</span>
                    </div>
                    <div class="profile-item">
                        <span class="profile-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</span>
                        <span class="profile-value">${startDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                    </div>
                    ${eventData.end_date ? `
                    <div class="profile-item">
                        <span class="profile-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</span>
                        <span class="profile-value">${new Date(eventData.end_date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                    </div>
                    ` : ''}
                    <div class="profile-item">
                        <span class="profile-label">–ì–æ—Ä–æ–¥:</span>
                        <span class="profile-value">${escapeHtml(eventData.city || '–ù–µ —É–∫–∞–∑–∞–Ω')}</span>
                    </div>
                    ${eventData.venue ? `
                    <div class="profile-item">
                        <span class="profile-label">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</span>
                        <span class="profile-value">${escapeHtml(eventData.venue)}</span>
                    </div>
                    ` : ''}
                    <div class="profile-item">
                        <span class="profile-label">–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã:</span>
                        <span class="profile-value">${ageGroupsText}</span>
                    </div>
                    ${eventData.sport ? `
                    <div class="profile-item">
                        <span class="profile-label">–í–∏–¥ —Å–ø–æ—Ä—Ç–∞:</span>
                        <span class="profile-value">${escapeHtml(eventData.sport)}</span>
                    </div>
                    ` : ''}
                    ${eventData.organization_name ? `
                    <div class="profile-item">
                        <span class="profile-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä:</span>
                        <span class="profile-value">${escapeHtml(eventData.organization_name)}</span>
                    </div>
                    ` : ''}
                    ${eventData.description ? `
                    <div class="profile-item" style="flex-direction: column; align-items: flex-start;">
                        <span class="profile-label" style="margin-bottom: 0.5rem;">–û–ø–∏—Å–∞–Ω–∏–µ:</span>
                        <span class="profile-value" style="white-space: pre-wrap;">${escapeHtml(eventData.description)}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-header">
                <h2 class="card-title">‚úÖ –°—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h2>
            </div>
            <div class="card-body">
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--secondary-blue); border-radius: 8px;">
                    <span style="font-size: 2rem;">${getStatusIcon(registrationData.registration.status)}</span>
                    <div>
                        <strong style="font-size: 1.1rem;">${getStatusText(registrationData.registration.status)}</strong>
                        <p style="margin: 0.25rem 0 0 0; color: var(--text-light);">
                            –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${new Date(registrationData.registration.created_at).toLocaleDateString('ru-RU')}
                        </p>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="cancelRegistration()">–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</button>
                </div>
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
                <span style="color: var(--text-light); font-size: 0.9rem;">
                    –í—Å–µ–≥–æ: ${participantsData.length}
                </span>
            </div>
            <div class="card-body">
                <div id="participantsList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${renderParticipantsList(participantsData)}
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏
    startCountdown(startDate);
}

function renderParticipantsList(participants) {
    if (!participants || participants.length === 0) {
        return '<p style="text-align: center; color: var(--text-light);">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
    }
    
    let html = '';
    participants.forEach((participant, index) => {
        html += `
            <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                <span style="font-size: 1.2rem; color: var(--text-light);">${index + 1}</span>
                <div style="flex: 1;">
                    <strong>${participant.athlete_role_id ? `<a href="/profiles/${participant.athlete_role_id}/" style="color: var(--primary-blue); text-decoration: none;">${escapeHtml(participant.athlete_name)}</a>` : escapeHtml(participant.athlete_name)}</strong>
                    ${participant.athlete_age ? `<span style="color: var(--text-light);"> (${participant.athlete_age} –ª–µ—Ç)</span>` : ''}
                    ${participant.athlete_sport ? `<br><small style="color: var(--text-light);">${escapeHtml(participant.athlete_sport)}</small>` : ''}
                </div>
                <span style="padding: 0.25rem 0.75rem; background: var(--primary-blue); color: white; border-radius: 12px; font-size: 0.85rem;">
                    ${getStatusText(participant.status)}
                </span>
            </div>
        `;
    });
    
    return html;
}

function getStatusIcon(status) {
    switch(status) {
        case 'registered': return 'üìù';
        case 'confirmed': return '‚úÖ';
        case 'cancelled': return '‚ùå';
        default: return '‚ùì';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'registered': return '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
        case 'confirmed': return '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
        case 'cancelled': return '–û—Ç–º–µ–Ω—ë–Ω';
        default: return status;
    }
}

function startCountdown(targetDate) {
    function updateCountdown() {
        const now = new Date();
        const diff = targetDate - now;
        
        const countdownEl = document.getElementById('countdown');
        if (!countdownEl) return;
        
        if (diff <= 0) {
            countdownEl.innerHTML = '<div style="color: #ff6b6b;">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–∞—á–∞–ª–æ—Å—å!</div>';
            return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        countdownEl.innerHTML = `
            <div style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; line-height: 1;">${days}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">–¥–Ω–µ–π</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 3rem; line-height: 1;">${hours}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">—á–∞—Å–æ–≤</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 3rem; line-height: 1;">${minutes}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">–º–∏–Ω—É—Ç</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 3rem; line-height: 1;">${seconds}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">—Å–µ–∫—É–Ω–¥</div>
                </div>
            </div>
        `;
    }
    
    updateCountdown();
    setInterval(updateCountdown, 1000);
}

function cancelRegistration() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?')) {
        return;
    }
    
    fetch(`/api/events/${eventId}/cancel/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json().then(data => ({ status: response.status, data })))
    .then(result => {
        if (result.status === 200) {
            alert(result.data.message);
            window.location.href = `/events/${eventId}/`;
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.profile-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.profile-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.profile-item:last-child {
    border-bottom: none;
}

.profile-label {
    font-weight: 600;
    color: var(--text-dark);
    min-width: 180px;
}

.profile-value {
    color: var(--text-light);
    flex: 1;
}
</style>
{% endblock %}
