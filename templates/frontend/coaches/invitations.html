{% extends 'base.html' %}
{% load static %}

{% block title %}–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-dashboard' %}" style="color: var(--primary-blue); text-decoration: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        </a>
    </div>
    
    <h1>üì® –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –Ω–∞ —Ä–∞–±–æ—Ç—É</h1>
    <p style="color: var(--text-light); margin-bottom: 2rem;">
        –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∏—Ö.
    </p>
    
    <div id="invitationsList">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
</div>

<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
function loadInvitations() {
    fetch('/api/coaches/invitations/', {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => response.json())
        .then(data => {
            renderInvitations(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            document.getElementById('invitationsList').innerHTML = 
                '<p style="color: var(--text-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>';
        });
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
function renderInvitations(invitations) {
    const container = document.getElementById('invitationsList');
    
    if (!invitations || invitations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">–ù–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
    invitations.forEach(inv => {
        html += `
            <div class="card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 0.5rem;">${escapeHtml(inv.organization_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}</h3>
                            ${inv.specialization_name ? `<p style="margin-bottom: 0.5rem;"><strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</strong> ${escapeHtml(inv.specialization_name)}</p>` : ''}
                            ${inv.message ? `
                                <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                                    <p style="margin-bottom: 0.5rem;"><strong>–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞:</strong></p>
                                    <p style="white-space: pre-wrap;">${escapeHtml(inv.message)}</p>
                                </div>
                            ` : ''}
                            <p style="color: var(--text-light); font-size: 0.9rem;">
                                –ü–æ–ª—É—á–µ–Ω–æ: ${new Date(inv.created_at).toLocaleString('ru-RU')}
                            </p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="acceptInvitation(${inv.id})">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="btn btn-danger" onclick="rejectInvitation(${inv.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// –ü—Ä–∏–Ω—è—Ç–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
function acceptInvitation(invitationId) {
    if (!confirm('–ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ —ç—Ç–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏?')) {
        return;
    }
    
    fetch(`/api/coaches/invitations/${invitationId}/accept/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            return response.json().then(data => ({ status: response.status, data }));
        })
        .then(result => {
            if (result.status === 200) {
                alert('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –¢–µ–ø–µ—Ä—å –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –≤ —ç—Ç–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.');
                loadInvitations();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
        });
}

// –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
function rejectInvitation(invitationId) {
    if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ?')) {
        return;
    }
    
    fetch(`/api/coaches/invitations/${invitationId}/reject/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            return response.json().then(data => ({ status: response.status, data }));
        })
        .then(result => {
            if (result.status === 200) {
                alert('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                loadInvitations();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadInvitations();
});

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
