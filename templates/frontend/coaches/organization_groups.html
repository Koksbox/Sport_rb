{% extends 'base.html' %}
{% load static %}

{% block title %}–ì—Ä—É–ø–ø—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-dashboard' %}" style="color: var(--primary-blue); text-decoration: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        </a>
    </div>
    
    <h1>üë• –ì—Ä—É–ø–ø—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h1>
    
    <div id="organizationInfo" style="margin-bottom: 2rem;">
        <div class="loading"></div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h2>
        </div>
        <div class="card-body" id="orgStats">
            <div class="loading"></div>
        </div>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–ú–æ–∏ –≥—Ä—É–ø–ø—ã –≤ —ç—Ç–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h2>
        </div>
        <div class="card-body" id="groupsList">
            <div class="loading"></div>
        </div>
    </div>
</div>

<script>
const orgId = {{ org_id }};

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
fetch(`/api/organizations/${orgId}/`)
    .then(response => response.json())
    .then(org => {
        document.getElementById('organizationInfo').innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h2>${escapeHtml(org.name || '')}</h2>
                    <p>${escapeHtml(org.address || '')}</p>
                    <p>${escapeHtml(org.city_name || '')}</p>
                </div>
            </div>
        `;
    });

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
fetch(`/api/attendance/organization/${orgId}/stats/`)
    .then(response => response.json())
    .then(stats => {
        const container = document.getElementById('orgStats');
        container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div class="card" style="padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary-blue);">${stats.overall.attendance_rate}%</div>
                    <div style="color: var(--text-light);">–û–±—â–∞—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
                </div>
                <div class="card" style="padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: green;">${stats.overall.present}</div>
                    <div style="color: var(--text-light);">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏</div>
                </div>
                <div class="card" style="padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: red;">${stats.overall.absent}</div>
                    <div style="color: var(--text-light);">–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏</div>
                </div>
            </div>
            <h4>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø–æ –≥—Ä—É–ø–ø–∞–º:</h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--secondary-blue);">
                            <th style="padding: 0.5rem; text-align: left;">–ì—Ä—É–ø–ø–∞</th>
                            <th style="padding: 0.5rem; text-align: center;">–í—Å–µ–≥–æ</th>
                            <th style="padding: 0.5rem; text-align: center;">–ü—Ä–∏—Å—É—Ç.</th>
                            <th style="padding: 0.5rem; text-align: center;">–û—Ç—Å—É—Ç.</th>
                            <th style="padding: 0.5rem; text-align: center;">%</th>
                            <th style="padding: 0.5rem; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.groups.map(g => `
                            <tr>
                                <td style="padding: 0.5rem;">${escapeHtml(g.group_name)}</td>
                                <td style="padding: 0.5rem; text-align: center;">${g.total}</td>
                                <td style="padding: 0.5rem; text-align: center; color: green;">${g.present}</td>
                                <td style="padding: 0.5rem; text-align: center; color: red;">${g.absent}</td>
                                <td style="padding: 0.5rem; text-align: center; font-weight: bold;">${g.attendance_rate}%</td>
                                <td style="padding: 0.5rem; text-align: center;">
                                    <a href="/coaches/groups/${g.group_id}/" class="btn btn-primary btn-sm">–û—Ç–∫—Ä—ã—Ç—å</a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    });

// –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø
fetch(`/api/coaches/organizations/${orgId}/groups/`)
    .then(response => response.json())
    .then(groups => {
        const container = document.getElementById('groupsList');
        if (groups && groups.length > 0) {
            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            groups.forEach(group => {
                html += `
                    <div class="card" style="padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin-bottom: 0.5rem;">${escapeHtml(group.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h4>
                                <p style="color: var(--text-light); margin: 0;">
                                    ${escapeHtml(group.sport_name || '')} ‚Ä¢ ${escapeHtml(group.age_level_name || '')}
                                </p>
                                <p style="color: var(--text-light); margin: 0;">–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤: ${group.enrollments ? group.enrollments.length : 0}</p>
                            </div>
                            <a href="/coaches/groups/${group.id}/" class="btn btn-primary">–£–ø—Ä–∞–≤–ª—è—Ç—å</a>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø –≤ —ç—Ç–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
        document.getElementById('groupsList').innerHTML = '<p style="color: var(--text-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</p>';
    });

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
