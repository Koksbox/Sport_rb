{% extends 'base.html' %}
{% load static %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-coach-groups' %}" style="color: var(--primary-blue); text-decoration: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–∞–º
        </a>
    </div>
    
    <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π</h1>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title" id="groupName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        </div>
        <div class="card-body" id="groupInfo">
            <div class="loading"></div>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (–∑–∞ 30 –¥–Ω–µ–π)</h2>
        </div>
        <div class="card-body" id="attendanceStats">
            <div class="loading"></div>
        </div>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ –∏ –æ—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–°–ø–æ—Ä—Ç—Å–º–µ–Ω—ã –≥—Ä—É–ø–ø—ã</h2>
        </div>
        <div class="card-body">
            <div style="margin-bottom: 1rem;">
                <label class="form-label">–î–∞—Ç–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏:</label>
                <input type="date" class="form-control" id="attendanceDate" style="max-width: 200px;" value="">
            </div>
            <div id="athletesList">
                <div class="loading"></div>
            </div>
        </div>
    </div>
</div>

<script>
const groupId = {{ group_id }};

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ
fetch(`/api/coaches/groups/`)
    .then(response => response.json())
    .then(groups => {
        const group = groups.find(g => g.id === groupId);
        if (group) {
            document.getElementById('groupName').textContent = group.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            document.getElementById('groupInfo').innerHTML = `
                <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> ${escapeHtml(group.organization_name || '')}</p>
                <p><strong>–í–∏–¥ —Å–ø–æ—Ä—Ç–∞:</strong> ${escapeHtml(group.sport_name || '')}</p>
                <p><strong>–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞:</strong> ${escapeHtml(group.age_level_name || '')}</p>
                <p><strong>–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤:</strong> ${group.enrollments ? group.enrollments.length : 0}</p>
            `;
            loadAthletes(group.enrollments || []);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø—ã:', error);
    });

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
fetch(`/api/attendance/group/${groupId}/stats/`)
    .then(response => response.json())
    .then(stats => {
        const container = document.getElementById('attendanceStats');
        container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div class="card" style="padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary-blue);">${stats.overall.attendance_rate}%</div>
                    <div style="color: var(--text-light);">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
                </div>
                <div class="card" style="padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: green;">${stats.overall.present}</div>
                    <div style="color: var(--text-light);">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏</div>
                </div>
                <div class="card" style="padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: red;">${stats.overall.absent}</div>
                    <div style="color: var(--text-light);">–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏</div>
                </div>
                <div class="card" style="padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: orange;">${stats.overall.late}</div>
                    <div style="color: var(--text-light);">–û–ø–æ–∑–¥–∞–ª–∏</div>
                </div>
            </div>
            <h4>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø–æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞–º:</h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--secondary-blue);">
                            <th style="padding: 0.5rem; text-align: left;">–°–ø–æ—Ä—Ç—Å–º–µ–Ω</th>
                            <th style="padding: 0.5rem; text-align: center;">–í—Å–µ–≥–æ</th>
                            <th style="padding: 0.5rem; text-align: center;">–ü—Ä–∏—Å—É—Ç.</th>
                            <th style="padding: 0.5rem; text-align: center;">–û—Ç—Å—É—Ç.</th>
                            <th style="padding: 0.5rem; text-align: center;">–û–ø–æ–∑–¥.</th>
                            <th style="padding: 0.5rem; text-align: center;">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.athletes.map(a => `
                            <tr>
                                <td style="padding: 0.5rem;">
                                    ${a.athlete_role_id ? `<a href="/profiles/${a.athlete_role_id}/" style="color: var(--primary-blue); text-decoration: none; font-weight: 500;">${escapeHtml(a.athlete_name)}</a>` : escapeHtml(a.athlete_name)}
                                </td>
                                <td style="padding: 0.5rem; text-align: center;">${a.total}</td>
                                <td style="padding: 0.5rem; text-align: center; color: green;">${a.present}</td>
                                <td style="padding: 0.5rem; text-align: center; color: red;">${a.absent}</td>
                                <td style="padding: 0.5rem; text-align: center; color: orange;">${a.late}</td>
                                <td style="padding: 0.5rem; text-align: center; font-weight: bold;">${a.attendance_rate}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        document.getElementById('attendanceStats').innerHTML = '<p style="color: var(--text-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>';
    });

function loadAthletes(enrollments) {
    const container = document.getElementById('athletesList');
    
    if (!enrollments || enrollments.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">–í –≥—Ä—É–ø–ø–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
    enrollments.forEach(enrollment => {
        if (enrollment.status === 'active' && enrollment.athlete) {
            html += `
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin-bottom: 0.5rem;">
                                ${enrollment.athlete.role_id ? `<a href="/profiles/${enrollment.athlete.role_id}/" style="color: var(--primary-blue); text-decoration: none;">${escapeHtml(enrollment.athlete.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏')}</a>` : escapeHtml(enrollment.athlete.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏')}
                            </h4>
                            <p style="color: var(--text-light); margin: 0;">${enrollment.athlete.main_sport || ''}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success" onclick="markAttendance(${enrollment.athlete.id}, 'present')">‚úì –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç</button>
                            <button class="btn btn-danger" onclick="markAttendance(${enrollment.athlete.id}, 'absent')">‚úó –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</button>
                            <button class="btn btn-warning" onclick="markAttendance(${enrollment.athlete.id}, 'late')">‚è∞ –û–ø–æ–∑–¥–∞–ª</button>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    html += '</div>';
    container.innerHTML = html;
}

function markAttendance(athleteId, status) {
    const date = document.getElementById('attendanceDate').value;
    
    if (!date) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
        return;
    }
    
    fetch('/api/attendance/mark/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            athlete: athleteId,
            group: groupId,
            date: date,
            status: status
        })
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 201) {
            alert('–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –æ—Ç–º–µ—á–µ–Ω–∞!');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏');
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
