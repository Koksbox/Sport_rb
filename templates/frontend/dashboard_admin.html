{% extends 'base.html' %}
{% load static %}
{% load role_names %}

{% block title %}–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px;">
    {% if all_roles|length > 1 %}
    <div class="card" style="margin-bottom: 1.5rem; background: var(--secondary-blue);">
        <div class="card-body">
            <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–æ–ª–∏</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% for role in all_roles %}
                <button class="role-switch-btn {% if role == active_role %}active{% endif %}" 
                        onclick="switchRole('{{ role }}')" 
                        data-role="{{ role }}">
                    {{ role|role_name }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <h1>‚öôÔ∏è –ö–∞–±–∏–Ω–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="statsContainer" style="margin-bottom: 2rem;">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</h2>
        </div>
        <div class="card-body">
            <div class="grid grid-4" style="gap: 1rem;">
                <button class="btn btn-primary" onclick="showSection('users')" style="padding: 1rem;">
                    üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </button>
                <button class="btn btn-primary" onclick="showSection('organizations')" style="padding: 1rem;">
                    üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                </button>
                <button class="btn btn-primary" onclick="showSection('moderation')" style="padding: 1rem;">
                    ‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è
                </button>
                <button class="btn btn-primary" onclick="showSection('logs')" style="padding: 1rem;">
                    üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
                </button>
            </div>
        </div>
    </div>
    
    <!-- –°–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div id="contentSections">
        <!-- –°–µ–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="section-users" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" class="form-control" id="userSearch" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ email, –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏..." 
                               style="max-width: 400px; display: inline-block; margin-right: 1rem;">
                        <select class="form-control" id="userRoleFilter" style="max-width: 200px; display: inline-block; margin-right: 1rem;">
                            <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                            <option value="athlete">–°–ø–æ—Ä—Ç—Å–º–µ–Ω</option>
                            <option value="coach">–¢—Ä–µ–Ω–µ—Ä</option>
                            <option value="parent">–†–æ–¥–∏—Ç–µ–ª—å</option>
                            <option value="director">–î–∏—Ä–µ–∫—Ç–æ—Ä</option>
                            <option value="admin_rb">–ê–¥–º–∏–Ω –†–ë</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadUsers()">–ü–æ–∏—Å–∫</button>
                    </div>
                    <div id="usersList">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π -->
        <div id="section-organizations" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <select class="form-control" id="orgStatusFilter" style="max-width: 200px; display: inline-block; margin-right: 1rem;">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="pending">–û–∂–∏–¥–∞—é—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏</option>
                            <option value="approved">–û–¥–æ–±—Ä–µ–Ω—ã</option>
                            <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω—ã</option>
                        </select>
                        <input type="text" class="form-control" id="orgSearch" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –ò–ù–ù..." 
                               style="max-width: 400px; display: inline-block; margin-right: 1rem;">
                        <button class="btn btn-primary" onclick="loadOrganizations()">–ü–æ–∏—Å–∫</button>
                    </div>
                    <div id="organizationsList">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
        <div id="section-moderation" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</h2>
                </div>
                <div class="card-body">
                    <div id="pendingOrganizations">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –ª–æ–≥–æ–≤ -->
        <div id="section-logs" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <button class="btn btn-secondary" onclick="loadLogs('audit')">–ê—É–¥–∏—Ç –ª–æ–≥–∏</button>
                        <button class="btn btn-secondary" onclick="loadLogs('django')" style="margin-left: 0.5rem;">Django –ª–æ–≥–∏</button>
                    </div>
                    <div id="logsContainer">
                        <p style="color: var(--text-light);">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ª–æ–≥–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSection = null;
let currentLogsType = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function loadStats() {
    fetch('/api/admin-rb/stats/')
        .then(response => response.json())
        .then(data => {
            renderStats(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            document.getElementById('statsContainer').innerHTML = 
                '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
        });
}

function renderStats(stats) {
    const container = document.getElementById('statsContainer');
    
    let html = `
        <div class="grid grid-4" style="gap: 1rem; margin-bottom: 1rem;">
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${stats.users.total}</h3>
                    <p style="margin: 0.5rem 0 0 0;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    <small>+${stats.users.this_month} –∑–∞ –º–µ—Å—è—Ü</small>
                </div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${stats.organizations.total}</h3>
                    <p style="margin: 0.5rem 0 0 0;">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</p>
                    <small>${stats.organizations.pending} –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</small>
                </div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${stats.events.total}</h3>
                    <p style="margin: 0.5rem 0 0 0;">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>
                    <small>${stats.events.upcoming} –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö</small>
                </div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${stats.attendance.rate}%</h3>
                    <p style="margin: 0.5rem 0 0 0;">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</p>
                    <small>${stats.attendance.attended} –∏–∑ ${stats.attendance.total_records}</small>
                </div>
            </div>
        </div>
        
        <div class="grid grid-3" style="gap: 1rem;">
            <div class="card">
                <div class="card-header">
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ä–æ–ª—è–º</h3>
                </div>
                <div class="card-body">
                    <ul style="list-style: none; padding: 0;">
                        ${stats.users.by_role.map(r => `
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                <strong>${getRoleName(r.role)}:</strong> ${r.count}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>–°—Ç–∞—Ç—É—Å—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</h3>
                </div>
                <div class="card-body">
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–û–¥–æ–±—Ä–µ–Ω—ã:</strong> ${stats.organizations.approved}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–û–∂–∏–¥–∞—é—Ç:</strong> ${stats.organizations.pending}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–û—Ç–∫–ª–æ–Ω–µ–Ω—ã:</strong> ${stats.organizations.rejected}
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ 30 –¥–Ω–µ–π</h3>
                </div>
                <div class="card-body">
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> ${stats.users.last_30_days}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–ù–æ–≤—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:</strong> ${stats.organizations.last_30_days}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–ù–æ–≤—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:</strong> ${stats.events.last_30_days}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function getRoleName(role) {
    const roles = {
        'athlete': '–°–ø–æ—Ä—Ç—Å–º–µ–Ω',
        'coach': '–¢—Ä–µ–Ω–µ—Ä',
        'parent': '–†–æ–¥–∏—Ç–µ–ª—å',
        'director': '–î–∏—Ä–µ–∫—Ç–æ—Ä',
        'organization': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è',
        'admin_rb': '–ê–¥–º–∏–Ω –†–ë',
        'moderator': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä'
    };
    return roles[role] || role;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
function showSection(sectionName) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
    const section = document.getElementById(`section-${sectionName}`);
    if (section) {
        section.style.display = 'block';
        currentSection = sectionName;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–∫—Ü–∏–∏
        if (sectionName === 'users') {
            loadUsers();
        } else if (sectionName === 'organizations') {
            loadOrganizations();
        } else if (sectionName === 'moderation') {
            loadPendingOrganizations();
        }
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function loadUsers(page = 1) {
    const search = document.getElementById('userSearch').value;
    const roleFilter = document.getElementById('userRoleFilter').value;
    
    let url = `/api/admin-rb/users/?page=${page}&page_size=20`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (roleFilter) url += `&role=${encodeURIComponent(roleFilter)}`;
    
    document.getElementById('usersList').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            renderUsers(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            document.getElementById('usersList').innerHTML = 
                '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        });
}

function renderUsers(data) {
    const container = document.getElementById('usersList');
    
    if (data.results.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    let html = `
        <div style="margin-bottom: 1rem;">
            <p>–ù–∞–π–¥–µ–Ω–æ: ${data.total} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        </div>
        <table class="table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>–§–ò–û</th>
                    <th>–†–æ–ª–∏</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                ${data.results.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${escapeHtml(user.email)}</td>
                        <td>${escapeHtml(user.first_name || '')} ${escapeHtml(user.last_name || '')}</td>
                        <td>${user.roles.map(r => getRoleName(r)).join(', ')}</td>
                        <td>
                            <span class="badge ${user.is_active ? 'badge-success' : 'badge-error'}">
                                ${user.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                            </span>
                        </td>
                        <td>${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
                        <td>
                            <button class="btn btn-sm ${user.is_active ? 'btn-secondary' : 'btn-primary'}" 
                                    onclick="toggleUserStatus(${user.id}, ${user.is_active})">
                                ${user.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

function toggleUserStatus(userId, currentStatus) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${currentStatus ? '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'} —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?`)) {
        return;
    }
    
    fetch(`/api/admin-rb/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200) {
            alert(result.data.message);
            loadUsers();
        } else {
            alert(result.data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
function loadOrganizations(page = 1) {
    const statusFilter = document.getElementById('orgStatusFilter').value;
    const search = document.getElementById('orgSearch').value;
    
    let url = `/api/admin-rb/organizations/?page=${page}&page_size=20`;
    if (statusFilter) url += `&status=${encodeURIComponent(statusFilter)}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    
    document.getElementById('organizationsList').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            renderOrganizations(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
            document.getElementById('organizationsList').innerHTML = 
                '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</div>';
        });
}

function renderOrganizations(data) {
    const container = document.getElementById('organizationsList');
    
    if (data.results.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    let html = `
        <div style="margin-bottom: 1rem;">
            <p>–ù–∞–π–¥–µ–Ω–æ: ${data.total} –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</p>
        </div>
        <table class="table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ò–ù–ù</th>
                    <th>–ì–æ—Ä–æ–¥</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–æ–∑–¥–∞—Ç–µ–ª—å</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                ${data.results.map(org => `
                    <tr>
                        <td>${org.id}</td>
                        <td>${escapeHtml(org.name)}</td>
                        <td>${escapeHtml(org.inn || '-')}</td>
                        <td>${escapeHtml(org.city || '-')}</td>
                        <td>
                            <span class="badge ${org.status === 'approved' ? 'badge-success' : org.status === 'pending' ? 'badge-warning' : 'badge-error'}">
                                ${org.status === 'approved' ? '–û–¥–æ–±—Ä–µ–Ω–∞' : org.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'}
                            </span>
                        </td>
                        <td>${org.created_by ? escapeHtml(org.created_by.email) : '-'}</td>
                        <td>${new Date(org.created_at).toLocaleDateString('ru-RU')}</td>
                        <td>
                            <a href="/organizations/${org.id}/" class="btn btn-sm btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
function loadPendingOrganizations() {
    document.getElementById('pendingOrganizations').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch('/api/admin-rb/organizations/pending/')
        .then(response => response.json())
        .then(data => {
            renderPendingOrganizations(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
            document.getElementById('pendingOrganizations').innerHTML = 
                '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</div>';
        });
}

function renderPendingOrganizations(orgs) {
    const container = document.getElementById('pendingOrganizations');
    
    if (orgs.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ù–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</p>';
        return;
    }
    
    let html = `
        <div class="grid grid-2" style="gap: 1rem;">
            ${orgs.map(org => `
                <div class="card">
                    <div class="card-body">
                        <h3 style="margin-bottom: 0.5rem;">${escapeHtml(org.name)}</h3>
                        <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                            –ò–ù–ù: ${escapeHtml(org.inn || '-')}<br>
                            –ì–æ—Ä–æ–¥: ${escapeHtml(org.city || '-')}<br>
                            –°–æ–∑–¥–∞—Ç–µ–ª—å: ${org.created_by ? escapeHtml(org.created_by.email) : '-'}
                        </p>
                        <div style="margin-top: 1rem;">
                            <a href="/organizations/${org.id}/" class="btn btn-primary" style="margin-right: 0.5rem;">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                            <button class="btn btn-success" onclick="approveOrganization(${org.id})">–û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button class="btn btn-secondary" onclick="rejectOrganization(${org.id})" style="margin-left: 0.5rem;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function approveOrganization(orgId) {
    if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é?')) return;
    
    fetch(`/api/organizations/${orgId}/moderate/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ action: 'approve' })
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200) {
            alert('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ–¥–æ–±—Ä–µ–Ω–∞');
            loadPendingOrganizations();
        } else {
            alert(result.data.error || '–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}

function rejectOrganization(orgId) {
    const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:');
    if (!reason) return;
    
    fetch(`/api/organizations/${orgId}/moderate/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ action: 'reject', reason: reason })
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200) {
            alert('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
            loadPendingOrganizations();
        } else {
            alert(result.data.error || '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
function loadLogs(type) {
    currentLogsType = type;
    document.getElementById('logsContainer').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch('/api/admin-rb/logs/')
        .then(response => response.json())
        .then(data => {
            renderLogs(data, type);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
            document.getElementById('logsContainer').innerHTML = 
                '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤</div>';
        });
}

function renderLogs(data, type) {
    const container = document.getElementById('logsContainer');
    
    if (type === 'audit') {
        if (data.audit_logs.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light);">–ù–µ—Ç –∞—É–¥–∏—Ç –ª–æ–≥–æ–≤</p>';
            return;
        }
        
        let html = `
            <div style="max-height: 600px; overflow-y: auto;">
                <table class="table" style="width: 100%; font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th>IP –∞–¥—Ä–µ—Å</th>
                            <th>–î–µ—Ç–∞–ª–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.audit_logs.map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString('ru-RU')}</td>
                                <td>${escapeHtml(log.user)}</td>
                                <td>${escapeHtml(log.action)}</td>
                                <td>${escapeHtml(log.ip_address || '-')}</td>
                                <td>${JSON.stringify(log.details)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        container.innerHTML = html;
    } else if (type === 'django') {
        if (data.django_logs.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light);">–ù–µ—Ç Django –ª–æ–≥–æ–≤</p>';
            return;
        }
        
        let html = `
            <div style="max-height: 600px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: var(--border-radius); font-family: monospace; font-size: 0.85rem;">
                ${data.django_logs.map(line => `<div style="margin-bottom: 0.25rem;">${escapeHtml(line)}</div>`).join('')}
            </div>
        `;
        container.innerHTML = html;
    }
}

function switchRole(role) {
    fetch('/api/users/switch-role/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ role: role })
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200 && result.data.success) {
            window.location.href = '/dashboard/';
        } else {
            alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–æ–ª–∏: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–æ–ª–∏');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
});
</script>

<style>
.role-switch-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--primary-blue);
    border-radius: var(--border-radius);
    background: white;
    color: var(--primary-blue);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.role-switch-btn:hover {
    background: var(--primary-blue);
    color: white;
}

.role-switch-btn.active {
    background: var(--primary-blue);
    color: white;
}

.table {
    border-collapse: collapse;
    width: 100%;
}

.table th, .table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.table th {
    background-color: var(--secondary-blue);
    font-weight: 600;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    font-size: 0.85rem;
    font-weight: 500;
}

.badge-success {
    background-color: #10b981;
    color: white;
}

.badge-warning {
    background-color: #f59e0b;
    color: white;
}

.badge-error {
    background-color: #ef4444;
    color: white;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
}
</style>
{% endblock %}
