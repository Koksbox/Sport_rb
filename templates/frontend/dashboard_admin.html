{% extends 'base.html' %}
{% load static %}
{% load role_names %}

{% block title %}–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px;">
    <!-- –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="user-profile-card">
        <div class="user-profile-header">
            <h2>–û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ</h2>
            <div class="user-profile-actions">
                <a href="{% url 'frontend-user-basic-data-edit' %}" class="btn btn-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            </div>
        </div>
        <div class="user-profile-content">
            <div class="profile-info">
                <div class="profile-item">
                    <span class="profile-label">–§–ò–û:</span>
                    <span class="profile-value">{{ user.get_full_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Email:</span>
                    <span class="profile-value">{{ user.email }}</span>
                </div>
                {% if user.phone %}
                <div class="profile-item">
                    <span class="profile-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                    <span class="profile-value">{{ user.phone }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–æ–ª–µ–π -->
    {% if all_roles|length > 1 %}
        {% include 'frontend/dashboard_parts/role_switcher.html' %}
    {% endif %}
    
    <!-- –í–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    {% include 'frontend/dashboard_parts/notifications_widget.html' %}
    
    <h1>‚öôÔ∏è –ö–∞–±–∏–Ω–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="statsContainer" style="margin-bottom: 2rem;">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</h2>
        </div>
        <div class="card-body">
            <div class="grid grid-4" style="gap: 1rem;">
                <button class="btn btn-primary" onclick="showSection('users')" style="padding: 1rem;">
                    üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </button>
                <button class="btn btn-primary" onclick="showSection('organizations')" style="padding: 1rem;">
                    üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                </button>
                <button class="btn btn-primary" onclick="showSection('moderation')" style="padding: 1rem;">
                    ‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è
                </button>
                <button class="btn btn-primary" onclick="showSection('events')" style="padding: 1rem;">
                    üèÜ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
                </button>
                <button class="btn btn-primary" onclick="showSection('notifications')" style="padding: 1rem;">
                    üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                </button>
                <button class="btn btn-primary" onclick="showSection('news')" style="padding: 1rem;">
                    üì∞ –ù–æ–≤–æ—Å—Ç–∏
                </button>
                <button class="btn btn-primary" onclick="showSection('roles')" style="padding: 1rem;">
                    üé≠ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
                </button>
                <button class="btn btn-primary" onclick="showSection('logs')" style="padding: 1rem;">
                    üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
                </button>
            </div>
        </div>
    </div>
    
    <!-- –°–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div id="contentSections">
        <!-- –°–µ–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div id="section-users" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" class="form-control" id="userSearch" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ email, –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏..." 
                               style="max-width: 400px; display: inline-block; margin-right: 1rem;">
                        <select class="form-control" id="userRoleFilter" style="max-width: 200px; display: inline-block; margin-right: 1rem;">
                            <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                            <option value="athlete">–°–ø–æ—Ä—Ç—Å–º–µ–Ω</option>
                            <option value="coach">–¢—Ä–µ–Ω–µ—Ä</option>
                            <option value="parent">–†–æ–¥–∏—Ç–µ–ª—å</option>
                            <option value="director">–î–∏—Ä–µ–∫—Ç–æ—Ä</option>
                            <option value="admin_rb">–ê–¥–º–∏–Ω –†–ë</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadUsers()">–ü–æ–∏—Å–∫</button>
                    </div>
                    <div id="usersList">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π -->
        <div id="section-organizations" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <select class="form-control" id="orgStatusFilter" style="max-width: 200px; display: inline-block; margin-right: 1rem;">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="pending">–û–∂–∏–¥–∞—é—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏</option>
                            <option value="approved">–û–¥–æ–±—Ä–µ–Ω—ã</option>
                            <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω—ã</option>
                        </select>
                        <input type="text" class="form-control" id="orgSearch" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –ò–ù–ù..." 
                               style="max-width: 400px; display: inline-block; margin-right: 1rem;">
                        <button class="btn btn-primary" onclick="loadOrganizations()">–ü–æ–∏—Å–∫</button>
                    </div>
                    <div id="organizationsList">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
        <div id="section-moderation" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</h2>
                </div>
                <div class="card-body">
                    <div id="pendingOrganizations">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
        <div id="section-events" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" class="form-control" id="eventSearch" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." 
                               style="max-width: 400px; display: inline-block; margin-right: 1rem;">
                        <select class="form-control" id="eventStatusFilter" style="max-width: 200px; display: inline-block; margin-right: 1rem;">
                            <option value="">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>
                            <option value="upcoming">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</option>
                            <option value="past">–ü—Ä–æ—à–µ–¥—à–∏–µ</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadEvents()">–ü–æ–∏—Å–∫</button>
                    </div>
                    <div id="eventsList">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
        <div id="section-notifications" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h2>
                </div>
                <div class="card-body">
                    <form id="notificationForm">
                        <div class="form-group">
                            <label class="form-label" for="notificationTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                            <input type="text" class="form-control" id="notificationTitle" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="notificationBody">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è *</label>
                            <textarea class="form-control" id="notificationBody" rows="5" required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ *</label>
                            <div style="margin-bottom: 1rem;">
                                <label>
                                    <input type="radio" name="notificationTarget" value="all" checked>
                                    –í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                                </label>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label>
                                    <input type="radio" name="notificationTarget" value="roles">
                                    –ü–æ —Ä–æ–ª—è–º:
                                </label>
                                <div id="rolesCheckboxes" style="margin-left: 2rem; margin-top: 0.5rem; display: none;">
                                    <label><input type="checkbox" name="targetRole" value="athlete"> –°–ø–æ—Ä—Ç—Å–º–µ–Ω—ã</label><br>
                                    <label><input type="checkbox" name="targetRole" value="coach"> –¢—Ä–µ–Ω–µ—Ä—ã</label><br>
                                    <label><input type="checkbox" name="targetRole" value="parent"> –†–æ–¥–∏—Ç–µ–ª–∏</label><br>
                                    <label><input type="checkbox" name="targetRole" value="director"> –î–∏—Ä–µ–∫—Ç–æ—Ä–∞</label><br>
                                    <label><input type="checkbox" name="targetRole" value="organization"> –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label><br>
                                    <label><input type="checkbox" name="targetRole" value="committee_staff"> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å–ø–æ—Ä—Ç–∫–æ–º–∏—Ç–µ—Ç–∞</label>
                                </div>
                            </div>
                            <div>
                                <label>
                                    <input type="radio" name="notificationTarget" value="event">
                                    –£—á–∞—Å—Ç–Ω–∏–∫–∞–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:
                                </label>
                                <input type="number" class="form-control" id="notificationEventId" 
                                       placeholder="ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" 
                                       style="max-width: 200px; margin-left: 2rem; margin-top: 0.5rem; display: none;">
                            </div>
                        </div>
                        <div id="notificationMessages"></div>
                        <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π -->
        <div id="section-news" class="content-section" style="display: none;">
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <h2 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç—è–º–∏</h2>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary" onclick="showCreateNewsForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
                </div>
            </div>
            <div id="newsListContainer">
                <div class="loading" style="margin: 2rem auto; display: block;"></div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏ -->
        <div id="section-roles" class="content-section" style="display: none;">
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <h2 class="card-title">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" class="form-control" id="roleUserSearch" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email..." 
                               style="max-width: 400px; display: inline-block; margin-right: 1rem;">
                        <button class="btn btn-primary" onclick="searchUserForRole()">–ù–∞–π—Ç–∏</button>
                    </div>
                    <div id="roleAssignmentContainer">
                        <p style="color: var(--text-light);">–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–ö–æ–¥—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–ø–æ—Ä—Ç–∫–æ–º–∏—Ç–µ—Ç–∞</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <button class="btn btn-primary" onclick="showGenerateCodeForm()">‚ûï –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥—ã</button>
                        <button class="btn btn-secondary" onclick="loadCommitteeCodes()" style="margin-left: 0.5rem;">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    </div>
                    <div id="committeeCodesList">
                        <div class="loading" style="margin: 2rem auto; display: block;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–µ–∫—Ü–∏—è –ª–æ–≥–æ–≤ -->
        <div id="section-logs" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">–õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <button class="btn btn-secondary" onclick="loadLogs('audit')">–ê—É–¥–∏—Ç –ª–æ–≥–∏</button>
                        <button class="btn btn-secondary" onclick="loadLogs('django')" style="margin-left: 0.5rem;">Django –ª–æ–≥–∏</button>
                    </div>
                    <div id="logsContainer">
                        <p style="color: var(--text-light);">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ª–æ–≥–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSection = null;
let currentLogsType = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function loadStats() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    fetch('/api/admin-rb/stats/', {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            try {
                const data = await response.json();
                if (response.ok) {
                    renderStats(data);
                } else {
                    throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
                throw new Error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
        } else {
            const text = await response.text();
            console.error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:', text);
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        document.getElementById('statsContainer').innerHTML = 
            '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderStats(stats) {
    const container = document.getElementById('statsContainer');
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    const usersTotal = stats.users?.total || 0;
    const usersThisMonth = stats.users?.this_month || 0;
    const usersLast30Days = stats.users?.last_30_days || 0;
    const usersByRole = stats.users?.by_role || [];
    
    const orgsTotal = stats.organizations?.total || 0;
    const orgsPending = stats.organizations?.pending || 0;
    const orgsApproved = stats.organizations?.approved || 0;
    const orgsRejected = stats.organizations?.rejected || 0;
    const orgsLast30Days = stats.organizations?.last_30_days || 0;
    
    const eventsTotal = stats.events?.total || 0;
    const eventsUpcoming = stats.events?.upcoming || 0;
    const eventsLast30Days = stats.events?.last_30_days || 0;
    
    const attendanceRate = stats.attendance?.rate || 0;
    const attendanceAttended = stats.attendance?.attended || 0;
    const attendanceTotal = stats.attendance?.total_records || 0;
    
    let html = `
        <div class="grid grid-4" style="gap: 1rem; margin-bottom: 1rem;">
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${usersTotal}</h3>
                    <p style="margin: 0.5rem 0 0 0;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    <small>+${usersThisMonth} –∑–∞ –º–µ—Å—è—Ü</small>
                </div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${orgsTotal}</h3>
                    <p style="margin: 0.5rem 0 0 0;">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</p>
                    <small>${orgsPending} –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</small>
                </div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${eventsTotal}</h3>
                    <p style="margin: 0.5rem 0 0 0;">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>
                    <small>${eventsUpcoming} –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö</small>
                </div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                <div class="card-body">
                    <h3 style="margin: 0; font-size: 2rem;">${attendanceRate.toFixed(1)}%</h3>
                    <p style="margin: 0.5rem 0 0 0;">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</p>
                    <small>${attendanceAttended} –∏–∑ ${attendanceTotal}</small>
                </div>
            </div>
        </div>
        
        <div class="grid grid-3" style="gap: 1rem;">
            <div class="card">
                <div class="card-header">
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ä–æ–ª—è–º</h3>
                </div>
                <div class="card-body">
                    ${usersByRole.length > 0 ? `
                        <ul style="list-style: none; padding: 0;">
                            ${usersByRole.map(r => `
                                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <strong>${getRoleName(r.role)}:</strong> ${r.count}
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p style="color: var(--text-light);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>'}
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>–°—Ç–∞—Ç—É—Å—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</h3>
                </div>
                <div class="card-body">
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–û–¥–æ–±—Ä–µ–Ω—ã:</strong> ${orgsApproved}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–û–∂–∏–¥–∞—é—Ç:</strong> ${orgsPending}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–û—Ç–∫–ª–æ–Ω–µ–Ω—ã:</strong> ${orgsRejected}
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ 30 –¥–Ω–µ–π</h3>
                </div>
                <div class="card-body">
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> ${usersLast30Days}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–ù–æ–≤—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:</strong> ${orgsLast30Days}
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <strong>–ù–æ–≤—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:</strong> ${eventsLast30Days}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function getRoleName(role) {
    const roles = {
        'athlete': '–°–ø–æ—Ä—Ç—Å–º–µ–Ω',
        'coach': '–¢—Ä–µ–Ω–µ—Ä',
        'parent': '–†–æ–¥–∏—Ç–µ–ª—å',
        'director': '–î–∏—Ä–µ–∫—Ç–æ—Ä',
        'organization': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è',
        'admin_rb': '–ê–¥–º–∏–Ω –†–ë',
        'moderator': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
        'committee_staff': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–ø–æ—Ä—Ç–∫–æ–º–∏—Ç–µ—Ç–∞'
    };
    return roles[role] || role;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
function showSection(sectionName) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
    const section = document.getElementById(`section-${sectionName}`);
    if (section) {
        section.style.display = 'block';
        currentSection = sectionName;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–∫—Ü–∏–∏
        if (sectionName === 'users') {
            loadUsers();
        } else if (sectionName === 'organizations') {
            loadOrganizations();
        } else if (sectionName === 'moderation') {
            loadPendingOrganizations();
        } else if (sectionName === 'events') {
            loadEvents();
        } else if (sectionName === 'notifications') {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            initNotificationForm();
        } else if (sectionName === 'news') {
            loadNewsArticles();
        } else if (sectionName === 'roles') {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–µ–∫—Ü–∏–∏
            loadCommitteeCodes();
        }
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function loadUsers(page = 1) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const search = document.getElementById('userSearch').value;
    const roleFilter = document.getElementById('userRoleFilter').value;
    
    let url = `/api/admin-rb/users/?page=${page}&page_size=20`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (roleFilter) url += `&role=${encodeURIComponent(roleFilter)}`;
    
    document.getElementById('usersList').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch(url, {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderUsers(data);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        document.getElementById('usersList').innerHTML = 
            '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderUsers(data) {
    const container = document.getElementById('usersList');
    
    if (data.results.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    let html = `
        <div style="margin-bottom: 1rem;">
            <p>–ù–∞–π–¥–µ–Ω–æ: ${data.total} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        </div>
        <table class="table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>–§–ò–û</th>
                    <th>–†–æ–ª–∏</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                ${data.results.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${escapeHtml(user.email)}</td>
                        <td>${escapeHtml(user.first_name || '')} ${escapeHtml(user.last_name || '')}</td>
                        <td>${user.roles.map(r => getRoleName(r)).join(', ')}</td>
                        <td>
                            <span class="badge ${user.is_active ? 'badge-success' : 'badge-error'}">
                                ${user.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                            </span>
                        </td>
                        <td>${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
                        <td>
                            <button class="btn btn-sm ${user.is_active ? 'btn-secondary' : 'btn-primary'}" 
                                    onclick="toggleUserStatus(${user.id}, ${user.is_active})">
                                ${user.is_active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

function toggleUserStatus(userId, currentStatus) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${currentStatus ? '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'} —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?`)) {
        return;
    }
    
    fetch(`/api/admin-rb/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 200) {
            alert(result.data.message || '–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω');
            loadUsers();
        } else {
            alert(result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
function loadOrganizations(page = 1) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const statusFilter = document.getElementById('orgStatusFilter').value;
    const search = document.getElementById('orgSearch').value;
    
    let url = `/api/admin-rb/organizations/?page=${page}&page_size=20`;
    if (statusFilter) url += `&status=${encodeURIComponent(statusFilter)}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    
    document.getElementById('organizationsList').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch(url, {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderOrganizations(data);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
        document.getElementById('organizationsList').innerHTML = 
            '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderOrganizations(data) {
    const container = document.getElementById('organizationsList');
    
    if (data.results.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    let html = `
        <div style="margin-bottom: 1rem;">
            <p>–ù–∞–π–¥–µ–Ω–æ: ${data.total} –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</p>
        </div>
        <table class="table" style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ò–ù–ù</th>
                    <th>–ì–æ—Ä–æ–¥</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–æ–∑–¥–∞—Ç–µ–ª—å</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                ${data.results.map(org => `
                    <tr>
                        <td>${org.id}</td>
                        <td>${escapeHtml(org.name)}</td>
                        <td>${escapeHtml(org.inn || '-')}</td>
                        <td>${escapeHtml(org.city || '-')}</td>
                        <td>
                            <span class="badge ${org.status === 'approved' ? 'badge-success' : org.status === 'pending' ? 'badge-warning' : 'badge-error'}">
                                ${org.status === 'approved' ? '–û–¥–æ–±—Ä–µ–Ω–∞' : org.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'}
                            </span>
                        </td>
                        <td>${org.created_by ? escapeHtml(org.created_by.email) : '-'}</td>
                        <td>${new Date(org.created_at).toLocaleDateString('ru-RU')}</td>
                        <td>
                            <a href="/organizations/${org.id}/" class="btn btn-sm btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
function loadPendingOrganizations() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    document.getElementById('pendingOrganizations').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch('/api/admin-rb/organizations/pending/', {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderPendingOrganizations(data);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
        document.getElementById('pendingOrganizations').innerHTML = 
            '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderPendingOrganizations(orgs) {
    const container = document.getElementById('pendingOrganizations');
    
    if (orgs.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ù–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</p>';
        return;
    }
    
    let html = `
        <div class="grid grid-2" style="gap: 1rem;">
            ${orgs.map(org => `
                <div class="card">
                    <div class="card-body">
                        <h3 style="margin-bottom: 0.5rem;">${escapeHtml(org.name)}</h3>
                        <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                            –ò–ù–ù: ${escapeHtml(org.inn || '-')}<br>
                            –ì–æ—Ä–æ–¥: ${escapeHtml(org.city || '-')}<br>
                            –°–æ–∑–¥–∞—Ç–µ–ª—å: ${org.created_by ? escapeHtml(org.created_by.email) : '-'}
                        </p>
                        <div style="margin-top: 1rem;">
                            <a href="/organizations/${org.id}/" class="btn btn-primary" style="margin-right: 0.5rem;">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                            <button class="btn btn-success" onclick="approveOrganization(${org.id})">–û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button class="btn btn-secondary" onclick="rejectOrganization(${org.id})" style="margin-left: 0.5rem;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function approveOrganization(orgId) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é?')) return;
    
    fetch(`/api/organizations/${orgId}/moderate/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: JSON.stringify({ action: 'approve' })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 200) {
            alert('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ–¥–æ–±—Ä–µ–Ω–∞');
            loadPendingOrganizations();
        } else {
            alert(result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    });
}

function rejectOrganization(orgId) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:');
    if (!reason) return;
    
    fetch(`/api/organizations/${orgId}/moderate/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: JSON.stringify({ action: 'reject', reason: reason })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 200) {
            alert('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
            loadPendingOrganizations();
        } else {
            alert(result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
function loadLogs(type) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    currentLogsType = type;
    document.getElementById('logsContainer').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch('/api/admin-rb/logs/', {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderLogs(data, type);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
        document.getElementById('logsContainer').innerHTML = 
            '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderLogs(data, type) {
    const container = document.getElementById('logsContainer');
    
    if (type === 'audit') {
        if (data.audit_logs.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light);">–ù–µ—Ç –∞—É–¥–∏—Ç –ª–æ–≥–æ–≤</p>';
            return;
        }
        
        let html = `
            <div style="max-height: 600px; overflow-y: auto;">
                <table class="table" style="width: 100%; font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            <th>IP –∞–¥—Ä–µ—Å</th>
                            <th>–î–µ—Ç–∞–ª–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.audit_logs.map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString('ru-RU')}</td>
                                <td>${escapeHtml(log.user)}</td>
                                <td>${escapeHtml(log.action)}</td>
                                <td>${escapeHtml(log.ip_address || '-')}</td>
                                <td>${JSON.stringify(log.details)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        container.innerHTML = html;
    } else if (type === 'django') {
        if (data.django_logs.length === 0) {
            container.innerHTML = '<p style="color: var(--text-light);">–ù–µ—Ç Django –ª–æ–≥–æ–≤</p>';
            return;
        }
        
        let html = `
            <div style="max-height: 600px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: var(--border-radius); font-family: monospace; font-size: 0.85rem;">
                ${data.django_logs.map(line => `<div style="margin-bottom: 0.25rem;">${escapeHtml(line)}</div>`).join('')}
            </div>
        `;
        container.innerHTML = html;
    }
}


function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
function loadEvents() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const search = document.getElementById('eventSearch').value;
    const statusFilter = document.getElementById('eventStatusFilter').value;
    
    let url = '/api/events/';
    const params = [];
    if (search) params.push(`search=${encodeURIComponent(search)}`);
    if (statusFilter === 'upcoming') params.push('upcoming=true');
    if (statusFilter === 'past') params.push('past=true');
    if (params.length > 0) url += '?' + params.join('&');
    
    document.getElementById('eventsList').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch(url, {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderEvents(Array.isArray(data) ? data : (data.results || []));
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:', error);
        document.getElementById('eventsList').innerHTML = 
            '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderEvents(events) {
    const container = document.getElementById('eventsList');
    
    if (events.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    let html = `
        <div style="margin-bottom: 1rem;">
            <p>–ù–∞–π–¥–µ–Ω–æ: ${events.length} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>
        </div>
        <div class="grid grid-2" style="gap: 1rem;">
            ${events.map(event => `
                <div class="card">
                    <div class="card-body">
                        <h3 style="margin-bottom: 0.5rem;">${escapeHtml(event.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h3>
                        <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                            ${event.start_date ? '–î–∞—Ç–∞: ' + new Date(event.start_date).toLocaleDateString('ru-RU') : ''}
                            ${event.location ? '<br>–ú–µ—Å—Ç–æ: ' + escapeHtml(event.location) : ''}
                        </p>
                        <div style="margin-top: 1rem;">
                            <a href="/events/${event.id}/" class="btn btn-primary btn-sm">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏
function searchUserForRole() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const search = document.getElementById('roleUserSearch').value.trim();
    if (!search) {
        alert('–í–≤–µ–¥–∏—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    document.getElementById('roleAssignmentContainer').innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch(`/api/admin-rb/users/?search=${encodeURIComponent(search)}&page_size=5`, {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderRoleAssignment(data.results || []);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        document.getElementById('roleAssignmentContainer').innerHTML = 
            '<div class="alert alert-error">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderRoleAssignment(users) {
    const container = document.getElementById('roleAssignmentContainer');
    
    if (users.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    let html = `
        <div class="grid grid-1" style="gap: 1rem;">
            ${users.map(user => `
                <div class="card">
                    <div class="card-body">
                        <h4 style="margin-bottom: 0.5rem;">${escapeHtml(user.email)}</h4>
                        <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                            ${user.first_name || ''} ${user.last_name || ''}
                            <br>–¢–µ–∫—É—â–∏–µ —Ä–æ–ª–∏: ${user.roles.map(r => getRoleName(r)).join(', ') || '–ù–µ—Ç —Ä–æ–ª–µ–π'}
                        </p>
                        <div style="margin-top: 1rem;">
                            <select class="form-control" id="roleSelect-${user.id}" style="max-width: 200px; display: inline-block; margin-right: 0.5rem;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                                <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                                <option value="admin_rb">–ê–¥–º–∏–Ω –†–ë</option>
                                <option value="committee_staff">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–ø–æ—Ä—Ç–∫–æ–º–∏—Ç–µ—Ç–∞</option>
                            </select>
                            <button class="btn btn-primary" onclick="assignRoleToUser(${user.id})">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å</button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    container.innerHTML = html;
}

function assignRoleToUser(userId, roleName = null) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const roleSelect = document.getElementById(`roleSelect-${userId}`);
    const role = roleSelect ? roleSelect.value : (roleName || '');
    
    if (!role) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å');
        return;
    }
    
    // –ï—Å–ª–∏ —Ä–æ–ª—å committee_staff, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
    if (role === 'committee_staff') {
        console.log('–í—ã–±—Ä–∞–Ω–∞ —Ä–æ–ª—å committee_staff, userId:', userId);
        try {
            showCommitteeStaffRoleForm(userId);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ showCommitteeStaffRoleForm:', error);
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
        return;
    }
    
    if (!confirm(`–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å "${getRoleName(role)}" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?`)) {
        return;
    }
    
    const requestData = { user_id: userId, role: role };
    
    fetch('/api/admin-rb/roles/assign/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 200 || result.status === 201) {
            alert(result.data.message || '–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞');
            searchUserForRole(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            alert(result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function initNotificationForm() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
    document.querySelectorAll('input[name="notificationTarget"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const rolesCheckboxes = document.getElementById('rolesCheckboxes');
            const eventInput = document.getElementById('notificationEventId');
            
            if (this.value === 'roles') {
                rolesCheckboxes.style.display = 'block';
                eventInput.style.display = 'none';
            } else if (this.value === 'event') {
                rolesCheckboxes.style.display = 'none';
                eventInput.style.display = 'inline-block';
            } else {
                rolesCheckboxes.style.display = 'none';
                eventInput.style.display = 'none';
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const form = document.getElementById('notificationForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            sendNotification();
        });
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function sendNotification() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const title = document.getElementById('notificationTitle').value.trim();
    const body = document.getElementById('notificationBody').value.trim();
    const targetType = document.querySelector('input[name="notificationTarget"]:checked')?.value;
    const messagesDiv = document.getElementById('notificationMessages');
    
    if (!title || !body) {
        messagesDiv.innerHTML = '<div class="alert alert-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</div>';
        return;
    }
    
    if (!targetType) {
        messagesDiv.innerHTML = '<div class="alert alert-error">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</div>';
        return;
    }
    
    const data = {
        title: title,
        body: body,
        notification_type: 'mass_notification'
    };
    
    if (targetType === 'all') {
        data.target_all = true;
    } else if (targetType === 'roles') {
        const selectedRoles = Array.from(document.querySelectorAll('input[name="targetRole"]:checked')).map(cb => cb.value);
        if (selectedRoles.length === 0) {
            messagesDiv.innerHTML = '<div class="alert alert-error">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–æ–ª—å</div>';
            return;
        }
        data.target_roles = selectedRoles;
    } else if (targetType === 'event') {
        const eventId = parseInt(document.getElementById('notificationEventId').value);
        if (!eventId || isNaN(eventId)) {
            messagesDiv.innerHTML = '<div class="alert alert-error">–í–≤–µ–¥–∏—Ç–µ ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>';
            return;
        }
        data.target_event_id = eventId;
    }
    
    messagesDiv.innerHTML = '<div class="alert alert-info">–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...</div>';
    
    fetch('/api/admin-rb/notifications/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const result = await response.json();
            return { status: response.status, data: result };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 201) {
            messagesDiv.innerHTML = '<div class="alert alert-success">' + 
                (result.data.message || `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${result.data.recipients_count || 0} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`) + 
                '</div>';
            document.getElementById('notificationForm').reset();
            const rolesCheckboxes = document.getElementById('rolesCheckboxes');
            const eventInput = document.getElementById('notificationEventId');
            if (rolesCheckboxes) rolesCheckboxes.style.display = 'none';
            if (eventInput) eventInput.style.display = 'none';
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + 
                (result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è') + 
                '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + 
            escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π
function loadNewsArticles() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const container = document.getElementById('newsListContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch('/api/admin-rb/news/', {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderNewsArticles(data);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
        container.innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π: ' + 
            escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function renderNewsArticles(articles) {
    const container = document.getElementById('newsListContainer');
    if (!container) return;
    
    if (articles.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        return;
    }
    
    let html = '<div class="grid grid-1" style="gap: 1rem;">';
    articles.forEach(article => {
        const date = article.created_at ? new Date(article.created_at).toLocaleDateString('ru-RU') : '';
        html += `
            <div class="card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0;">${escapeHtml(article.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h3>
                        <span class="badge ${article.is_published ? 'badge-success' : 'badge-warning'}">
                            ${article.is_published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'}
                        </span>
                    </div>
                    <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                        –ê–≤—Ç–æ—Ä: ${escapeHtml(article.author_name || article.author_email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')} | 
                        –î–∞—Ç–∞: ${date}
                    </p>
                    ${article.excerpt ? `<p style="color: var(--text-light); margin-bottom: 0.5rem;">${escapeHtml(article.excerpt)}</p>` : ''}
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary btn-sm" onclick="editNewsArticle(${article.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNewsArticle(${article.id})" style="margin-left: 0.5rem;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function showCreateNewsForm() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'createNewsModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</h3>
                <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createNewsForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label" for="newsTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                        <input type="text" class="form-control" id="newsTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newsExcerpt">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="newsExcerpt" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newsContent">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *</label>
                        <textarea class="form-control" id="newsContent" rows="10" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newsImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        <input type="file" class="form-control" id="newsImage" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="newsPublished">
                            –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
                        </label>
                    </div>
                    <div id="newsFormMessages"></div>
                    <div style="margin-top: 1rem;">
                        <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.classList.add('show');
    modal.style.display = 'flex';
    
    document.getElementById('createNewsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createNewsArticle();
    });
}

function createNewsArticle() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const formData = new FormData();
    formData.append('title', document.getElementById('newsTitle').value);
    formData.append('content', document.getElementById('newsContent').value);
    formData.append('excerpt', document.getElementById('newsExcerpt').value);
    formData.append('is_published', document.getElementById('newsPublished').checked);
    
    const imageFile = document.getElementById('newsImage').files[0];
    if (imageFile) {
        formData.append('image', imageFile);
    }
    
    const messagesDiv = document.getElementById('newsFormMessages');
    messagesDiv.innerHTML = '<div class="alert alert-info">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏...</div>';
    
    fetch('/api/admin-rb/news/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: formData
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 201) {
            messagesDiv.innerHTML = '<div class="alert alert-success">–ù–æ–≤–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</div>';
            setTimeout(() => {
                const modal = document.getElementById('createNewsModal');
                if (modal) modal.remove();
                loadNewsArticles();
            }, 1500);
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + 
                (result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–∏') + 
                '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + 
            escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function editNewsArticle(articleId) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    fetch(`/api/admin-rb/news/${articleId}/`, {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const data = await response.json();
        if (response.ok) {
            showEditNewsForm(data);
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—å–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—å–∏');
    });
}

function showEditNewsForm(article) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'editNewsModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</h3>
                <span class="close" onclick="this.closest('.modal').remove()">√ó</span>
            </div>
            <div class="modal-body">
                <form id="editNewsForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label" for="editNewsTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                        <input type="text" class="form-control" id="editNewsTitle" value="${escapeHtml(article.title || '')}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editNewsExcerpt">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="editNewsExcerpt" rows="2">${escapeHtml(article.excerpt || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editNewsContent">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *</label>
                        <textarea class="form-control" id="editNewsContent" rows="10" required>${escapeHtml(article.content || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editNewsImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        <input type="file" class="form-control" id="editNewsImage" accept="image/*">
                        ${article.image ? `<p style="color: var(--text-light); font-size: 0.9rem;">–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: <a href="${article.image}" target="_blank">–ü—Ä–æ—Å–º–æ—Ç—Ä</a></p>` : ''}
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editNewsPublished" ${article.is_published ? 'checked' : ''}>
                            –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ
                        </label>
                    </div>
                    <div id="editNewsFormMessages"></div>
                    <div style="margin-top: 1rem;">
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.classList.add('show');
    modal.style.display = 'flex';
    
    document.getElementById('editNewsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateNewsArticle(article.id);
    });
}

function updateNewsArticle(articleId) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const formData = new FormData();
    formData.append('title', document.getElementById('editNewsTitle').value);
    formData.append('content', document.getElementById('editNewsContent').value);
    formData.append('excerpt', document.getElementById('editNewsExcerpt').value);
    formData.append('is_published', document.getElementById('editNewsPublished').checked);
    
    const imageFile = document.getElementById('editNewsImage').files[0];
    if (imageFile) {
        formData.append('image', imageFile);
    }
    
    const messagesDiv = document.getElementById('editNewsFormMessages');
    messagesDiv.innerHTML = '<div class="alert alert-info">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</div>';
    
    fetch(`/api/admin-rb/news/${articleId}/`, {
        method: 'PATCH',
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: formData
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 200) {
            messagesDiv.innerHTML = '<div class="alert alert-success">–ù–æ–≤–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</div>';
            setTimeout(() => {
                const modal = document.getElementById('editNewsModal');
                if (modal) modal.remove();
                loadNewsArticles();
            }, 1500);
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + 
                (result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–∏') + 
                '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + 
            escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

function deleteNewsArticle(articleId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å?')) {
        return;
    }
    
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    fetch(`/api/admin-rb/news/${articleId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            return { status: response.status, data: {} };
        }
    })
    .then(result => {
        if (result.status === 200) {
            alert('–ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞');
            loadNewsArticles();
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏');
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏ committee_staff
function showCommitteeStaffRoleForm(userId) {
    console.log('showCommitteeStaffRoleForm –≤—ã–∑–≤–∞–Ω–∞, userId:', userId);
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'committeeStaffRoleModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–ø–æ—Ä—Ç–∫–æ–º–∏—Ç–µ—Ç–∞"</h3>
                <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="committeeStaffRoleForm">
                    <div class="form-group">
                        <label class="form-label">–°–ø–æ—Å–æ–± –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">
                                <input type="radio" name="fillMethod" value="code" checked>
                                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                            </label>
                            <label style="display: block;">
                                <input type="radio" name="fillMethod" value="manual">
                                –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                            </label>
                        </div>
                    </div>
                    
                    <div id="codeInputSection">
                        <div class="form-group">
                            <label class="form-label" for="committeeCode">–ö–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ *</label>
                            <input type="text" class="form-control" id="committeeCode" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" 
                                   style="text-transform: uppercase;"
                                   maxlength="20">
                            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">–ö–æ–¥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∏–∑ –Ω–µ–≥–æ</small>
                        </div>
                    </div>
                    
                    <div id="manualInputSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="committeeCity">–ì–æ—Ä–æ–¥ *</label>
                            <input type="text" class="form-control" id="committeeCity" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—Ñ–∞">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="committeeDepartment">–û—Ç–¥–µ–ª/–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                            <input type="text" class="form-control" id="committeeDepartment" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="committeePosition">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                            <input type="text" class="form-control" id="committeePosition" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                        </div>
                    </div>
                    
                    <div id="committeeRoleMessages"></div>
                    <div style="margin-top: 1rem;">
                        <button type="submit" class="btn btn-primary">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å</button>
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.classList.add('show');
    modal.style.display = 'flex';
    
    const form = document.getElementById('committeeStaffRoleForm');
    if (!form) {
        console.error('–§–æ—Ä–º–∞ committeeStaffRoleForm –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–ø–æ—Å–æ–±–∞–º–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    document.querySelectorAll('input[name="fillMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const codeSection = document.getElementById('codeInputSection');
            const manualSection = document.getElementById('manualInputSection');
            if (this.value === 'code') {
                codeSection.style.display = 'block';
                manualSection.style.display = 'none';
                document.getElementById('committeeCode').required = true;
                document.getElementById('committeeCity').required = false;
            } else {
                codeSection.style.display = 'none';
                manualSection.style.display = 'block';
                document.getElementById('committeeCode').required = false;
                document.getElementById('committeeCity').required = true;
            }
        });
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏ committee_staff');
        assignCommitteeStaffRole(userId);
    });
    
    console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–æ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ');
}

// –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å committee_staff
function assignCommitteeStaffRole(userId) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const fillMethod = document.querySelector('input[name="fillMethod"]:checked')?.value;
    const messagesDiv = document.getElementById('committeeRoleMessages');
    
    const requestData = {
        user_id: userId,
        role: 'committee_staff'
    };
    
    if (fillMethod === 'code') {
        const code = document.getElementById('committeeCode').value.trim().toUpperCase();
        if (!code) {
            messagesDiv.innerHTML = '<div class="alert alert-error">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>';
            return;
        }
        requestData.registration_code = code;
    } else {
        const city = document.getElementById('committeeCity').value.trim();
        const department = document.getElementById('committeeDepartment').value.trim();
        const position = document.getElementById('committeePosition').value.trim();
        
        if (!city) {
            messagesDiv.innerHTML = '<div class="alert alert-error">–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥</div>';
            return;
        }
        
        requestData.city_name = city;
        requestData.department = department;
        requestData.position = position;
    }
    
    messagesDiv.innerHTML = '<div class="alert alert-info">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏...</div>';
    
    fetch('/api/admin-rb/roles/assign/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 200 || result.status === 201) {
            const fillMethod = document.querySelector('input[name="fillMethod"]:checked')?.value;
            messagesDiv.innerHTML = '<div class="alert alert-success">–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞!' + 
                (fillMethod === 'code' ? ' –î–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–∑ –∫–æ–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.' : ' –ö–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.') + 
                '</div>';
            setTimeout(() => {
                const modal = document.getElementById('committeeStaffRoleModal');
                if (modal) modal.remove();
                searchUserForRole();
            }, 2000);
        } else {
            let errorMsg = '–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–∏';
            if (result.data) {
                if (typeof result.data === 'string') {
                    errorMsg = result.data;
                } else if (result.data.error) {
                    errorMsg = result.data.error;
                } else if (result.data.detail) {
                    errorMsg = result.data.detail;
                } else if (typeof result.data === 'object') {
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                    const errors = [];
                    for (const key in result.data) {
                        if (Array.isArray(result.data[key])) {
                            errors.push(`${key}: ${result.data[key].join(', ')}`);
                        } else {
                            errors.push(`${key}: ${result.data[key]}`);
                        }
                    }
                    errorMsg = errors.join('<br>');
                }
            }
            messagesDiv.innerHTML = '<div class="alert alert-error">' + escapeHtml(errorMsg) + '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + 
            escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–æ–≤
function showGenerateCodeForm() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'generateCodeModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h3>
                <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="generateCodeForm">
                    <div class="form-group">
                        <label class="form-label" for="codeCity">–ì–æ—Ä–æ–¥ *</label>
                        <input type="text" class="form-control" id="codeCity" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—Ñ–∞">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="codeCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤ *</label>
                        <input type="number" class="form-control" id="codeCount" min="1" max="100" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="codeDepartment">–û—Ç–¥–µ–ª/–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="codeDepartment" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="codePosition">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                        <input type="text" class="form-control" id="codePosition" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="codeExpiresDays">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–µ–π)</label>
                        <input type="number" class="form-control" id="codeExpiresDays" min="1" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è –±–µ—Å—Å—Ä–æ—á–Ω–æ–≥–æ">
                    </div>
                    <div id="generateCodeMessages"></div>
                    <div style="margin-top: 1rem;">
                        <button type="submit" class="btn btn-primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.classList.add('show');
    modal.style.display = 'flex';
    
    document.getElementById('generateCodeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateCodes();
    });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–æ–≤
function generateCodes() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const city = document.getElementById('codeCity').value.trim();
    const count = parseInt(document.getElementById('codeCount').value);
    const department = document.getElementById('codeDepartment').value.trim();
    const position = document.getElementById('codePosition').value.trim();
    const expiresDays = document.getElementById('codeExpiresDays').value ? parseInt(document.getElementById('codeExpiresDays').value) : null;
    const messagesDiv = document.getElementById('generateCodeMessages');
    
    if (!city || !count || count < 1) {
        messagesDiv.innerHTML = '<div class="alert alert-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</div>';
        return;
    }
    
    messagesDiv.innerHTML = '<div class="alert alert-info">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–æ–≤...</div>';
    
    const requestData = {
        city_name: city,
        count: count,
        department: department,
        position: position
    };
    
    if (expiresDays) {
        requestData.expires_days = expiresDays;
    }
    
    fetch('/api/admin-rb/committee-codes/generate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookieFunc('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            return { status: response.status, data };
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .then(result => {
        if (result.status === 201) {
            let codesHtml = '<div class="alert alert-success"><strong>–ö–æ–¥—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã:</strong><br><br>';
            result.data.codes.forEach(code => {
                codesHtml += `<code style="background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px; margin-right: 0.5rem;">${escapeHtml(code.code)}</code>`;
            });
            codesHtml += '</div>';
            messagesDiv.innerHTML = codesHtml;
            setTimeout(() => {
                document.getElementById('generateCodeModal').remove();
                loadCommitteeCodes();
            }, 3000);
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + 
                (result.data.error || result.data.detail || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–æ–≤') + 
                '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + 
            escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–¥–æ–≤
function loadCommitteeCodes() {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    const container = document.getElementById('committeeCodesList');
    if (!container) return;
    
    container.innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...');
    fetch('/api/admin-rb/committee-codes/?status=all', {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            console.log('–î–∞–Ω–Ω—ã–µ –∫–æ–¥–æ–≤:', data);
            if (response.ok) {
                renderCommitteeCodes(data.results || []);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤');
            }
        } else {
            const text = await response.text();
            console.error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:', text);
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: ' + text.substring(0, 100));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤:', error);
        if (container) {
            container.innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤: ' + 
                escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
        }
    });
}

function renderCommitteeCodes(codes) {
    const container = document.getElementById('committeeCodesList');
    if (!container) return;
    
    if (codes.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">–ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        return;
    }
    
    // –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–¥—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    const unusedCodes = codes.filter(c => !c.is_used && c.is_active);
    const usedCodes = codes.filter(c => c.is_used);
    const archivedCodes = codes.filter(c => !c.is_active);
    
    let html = '';
    
    // –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã (–≤—ã–¥–µ–ª—è–µ–º —è—Ä–∫–æ)
    if (unusedCodes.length > 0) {
        html += '<div style="margin-bottom: 2rem;">';
        html += '<h4 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">';
        html += '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">–ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ</span>';
        html += `<span style="color: var(--text-light); font-size: 0.9rem; font-weight: normal;">(${unusedCodes.length})</span>`;
        html += '</h4>';
        html += '<div class="grid grid-1" style="gap: 1rem;">';
        unusedCodes.forEach(code => {
            html += renderCodeCard(code, true);
        });
        html += '</div>';
        html += '</div>';
    }
    
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã
    if (usedCodes.length > 0) {
        html += '<div style="margin-bottom: 2rem;">';
        html += '<h4 style="color: var(--text-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">';
        html += '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ</span>';
        html += `<span style="color: var(--text-light); font-size: 0.9rem; font-weight: normal;">(${usedCodes.length})</span>`;
        html += '</h4>';
        html += '<div class="grid grid-1" style="gap: 1rem;">';
        usedCodes.forEach(code => {
            html += renderCodeCard(code, false);
        });
        html += '</div>';
        html += '</div>';
    }
    
    // –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã
    if (archivedCodes.length > 0) {
        html += '<div style="margin-bottom: 2rem;">';
        html += '<h4 style="color: var(--text-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">';
        html += '<span style="background: #6b7280; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">–ê—Ä—Ö–∏–≤</span>';
        html += `<span style="color: var(--text-light); font-size: 0.9rem; font-weight: normal;">(${archivedCodes.length})</span>`;
        html += '</h4>';
        html += '<div class="grid grid-1" style="gap: 1rem;">';
        archivedCodes.forEach(code => {
            html += renderCodeCard(code, false);
        });
        html += '</div>';
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function renderCodeCard(code, isUnused) {
    const date = code.created_at ? new Date(code.created_at).toLocaleDateString('ru-RU') : '';
    const usedDate = code.used_at ? new Date(code.used_at).toLocaleDateString('ru-RU') : '';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
    let cardStyle = 'border: 2px solid var(--gray);';
    if (isUnused) {
        cardStyle = 'border: 2px solid #10b981; background: #f0fdf4;';
    } else if (code.is_used) {
        cardStyle = 'border: 2px solid #f59e0b; background: #fffbeb; opacity: 0.8;';
    } else if (!code.is_active) {
        cardStyle = 'border: 2px solid #6b7280; background: #f9fafb; opacity: 0.7;';
    }
    
    let badgeClass = 'badge-success';
    let badgeText = '–ê–∫—Ç–∏–≤–µ–Ω';
    if (code.is_used) {
        badgeClass = 'badge-warning';
        badgeText = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω';
    } else if (!code.is_active) {
        badgeClass = 'badge-secondary';
        badgeText = '–í –∞—Ä—Ö–∏–≤–µ';
    }
    
    let actionsHtml = '';
    if (!code.is_used && code.is_active) {
        // –î–ª—è –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–¥–æ–≤ - –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è
        actionsHtml = `
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-sm btn-secondary" onclick="archiveCode(${code.id})" style="font-size: 0.85rem;">
                    üì¶ –í –∞—Ä—Ö–∏–≤
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteCode(${code.id})" style="font-size: 0.85rem;">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        `;
    } else if (!code.is_active) {
        // –î–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö - –∫–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        actionsHtml = `
            <div style="margin-top: 1rem;">
                <button class="btn btn-sm btn-primary" onclick="restoreCode(${code.id})" style="font-size: 0.85rem;">
                    ‚Üª –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        `;
    }
    
    return `
        <div class="card" style="${cardStyle}">
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0;">
                            –ö–æ–¥: <code style="background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 1.1rem; font-weight: bold;">${escapeHtml(code.code)}</code>
                        </h4>
                        <p style="color: var(--text-light); margin: 0.25rem 0;">
                            –ì–æ—Ä–æ–¥: <strong>${escapeHtml(code.city_name)}</strong>
                            ${code.department ? ' | –û—Ç–¥–µ–ª: ' + escapeHtml(code.department) : ''}
                            ${code.position ? ' | –î–æ–ª–∂–Ω–æ—Å—Ç—å: ' + escapeHtml(code.position) : ''}
                        </p>
                    </div>
                    <span class="badge ${badgeClass}" style="margin-left: 1rem;">
                        ${badgeText}
                    </span>
                </div>
                ${code.used_by_email ? `<p style="color: var(--text-light); font-size: 0.9rem; margin: 0.25rem 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: <strong>${escapeHtml(code.used_by_email)}</strong>${usedDate ? ' (' + usedDate + ')' : ''}</p>` : ''}
                <p style="color: var(--text-light); font-size: 0.9rem; margin: 0.25rem 0;">
                    –°–æ–∑–¥–∞–Ω: ${date} | –í—ã–¥–∞–Ω: ${escapeHtml(code.issued_by || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
                </p>
                ${actionsHtml}
            </div>
        </div>
    `;
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–¥–∞
function deleteCode(codeId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–¥? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    fetch(`/api/admin-rb/committee-codes/${codeId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const data = await response.json();
        return { status: response.status, data };
    })
    .then(result => {
        if (result.status === 200) {
            loadCommitteeCodes();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–æ–¥'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–¥–∞');
    });
}

// –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
function archiveCode(codeId) {
    if (!confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–æ–¥ –≤ –∞—Ä—Ö–∏–≤? –ï–≥–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ.')) {
        return;
    }
    
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    fetch(`/api/admin-rb/committee-codes/${codeId}/archive/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const data = await response.json();
        return { status: response.status, data };
    })
    .then(result => {
        if (result.status === 200) {
            loadCommitteeCodes();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–¥–∞');
    });
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞
function restoreCode(codeId) {
    const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    
    fetch(`/api/admin-rb/committee-codes/${codeId}/restore/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(async response => {
        const data = await response.json();
        return { status: response.status, data };
    })
    .then(result => {
        if (result.status === 200) {
            loadCommitteeCodes();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–¥'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞');
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
});
</script>

<style>
.user-profile-card {
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 2px 10px var(--shadow);
    margin-bottom: 2rem;
    border: 2px solid var(--secondary-blue);
}

.user-profile-header {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
    color: var(--white);
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.user-profile-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    color: var(--white);
}

.user-profile-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.user-profile-content {
    padding: 1.5rem;
}

@media (max-width: 768px) {
    .user-profile-header {
        flex-direction: column;
        align-items: flex-start;
    }
}

.table {
    border-collapse: collapse;
    width: 100%;
}

.table th, .table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.table th {
    background-color: var(--secondary-blue);
    font-weight: 600;
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    font-size: 0.85rem;
    font-weight: 500;
}

.badge-success {
    background-color: #10b981;
    color: white;
}

.badge-warning {
    background-color: #f59e0b;
    color: white;
}

.badge-error {
    background-color: #ef4444;
    color: white;
}

.badge-secondary {
    background-color: #6b7280;
    color: white;
}

.badge-danger {
    background-color: #ef4444;
    color: white;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
}

.btn-danger {
    background-color: #ef4444;
    color: white;
    border: none;
}

.btn-danger:hover {
    background-color: #dc2626;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
.modal {
    display: none;
    position: fixed !important;
    z-index: 10000 !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    height: 100% !important;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background-color: var(--white);
    margin: auto;
    padding: 0;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
    position: relative;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
    color: var(--white);
    border-radius: 12px 12px 0 0;
}

.modal-header h3 {
    margin: 0;
    color: var(--white);
}

.modal .close {
    color: var(--white);
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    background: none;
    border: none;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.modal .close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 1.5rem;
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        max-height: 95vh;
        margin: 2.5vh auto;
    }
}
</style>
{% endblock %}
