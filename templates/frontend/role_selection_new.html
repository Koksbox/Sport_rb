{% extends 'base.html' %}
{% load static %}

{% block title %}–í—ã–±–æ—Ä –Ω–æ–≤–æ–π —Ä–æ–ª–∏ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 700px;">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-dashboard' %}" style="color: var(--primary-blue); text-decoration: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        </a>
    </div>
    
    <h1>–í—ã–±–æ—Ä –Ω–æ–≤–æ–π —Ä–æ–ª–∏</h1>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</h2>
        </div>
        <div class="card-body">
            <p style="margin-bottom: 1.5rem; color: var(--text-light);">
                –í—ã –º–æ–∂–µ—Ç–µ –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫ —Å–≤–æ–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É.
            </p>
            
            <div id="messages"></div>
            
            <p style="margin-bottom: 1rem; color: var(--text-light); font-size: 0.9rem;">
                <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –†–æ–ª—å "–†–æ–¥–∏—Ç–µ–ª—å" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–±—ë–Ω–∫–∞. 
                –†–æ–ª—å "–î–∏—Ä–µ–∫—Ç–æ—Ä" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.
            </p>
            
            <div class="grid grid-2" style="gap: 1rem;">
                <div class="role-card" data-role="athlete" onclick="selectRole('athlete')">
                    <div class="role-icon">üèÉ</div>
                    <h3>–°–ø–æ—Ä—Ç—Å–º–µ–Ω</h3>
                    <p>–£—á–∞—Å—Ç–∏–µ –≤ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è—Ö, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
                </div>
                
                <div class="role-card" data-role="coach" onclick="selectRole('coach')">
                    <div class="role-icon">üèãÔ∏è</div>
                    <h3>–¢—Ä–µ–Ω–µ—Ä</h3>
                    <p>–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.role-card {
    padding: 1.5rem;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--bg-white);
}

.role-card:hover {
    border-color: var(--primary-blue);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.role-card.selected {
    border-color: var(--primary-blue);
    background: var(--secondary-blue);
}

.role-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.role-card h3 {
    margin: 0.5rem 0;
    color: var(--text-dark);
}

.role-card p {
    margin: 0;
    color: var(--text-light);
    font-size: 0.9rem;
}
</style>

<script>
function selectRole(role) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å "${getRoleName(role)}"?\n\n–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã –ø–µ—Ä–µ–π–¥–µ—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —ç—Ç–æ–π —Ä–æ–ª–∏.`)) {
        return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–±–æ—Ä —Ä–æ–ª–∏
    fetch('/api/users/select-role/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ role: role })
    })
    .then(response => response.json().then(data => ({ status: response.status, data })))
    .then(result => {
        if (result.status === 201) {
            // –£—Å–ø–µ—à–Ω–æ - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            if (result.data.needs_profile_completion && result.data.profile_url) {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                window.location.href = result.data.profile_url;
            } else {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                window.location.href = '/dashboard/';
            }
        } else {
            // –û—à–∏–±–∫–∞
            const messagesDiv = document.getElementById('messages');
            let errorMsg = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
            if (result.data.error) {
                errorMsg = result.data.error;
            } else if (result.data.role) {
                errorMsg = result.data.role[0] || errorMsg;
            }
            messagesDiv.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        document.getElementById('messages').innerHTML = 
            '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–æ–ª–∏</div>';
    });
}

function getRoleName(role) {
    const names = {
        'athlete': '–°–ø–æ—Ä—Ç—Å–º–µ–Ω',
        'parent': '–†–æ–¥–∏—Ç–µ–ª—å',
        'coach': '–¢—Ä–µ–Ω–µ—Ä',
        'organization': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'
    };
    return names[role] || role;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
