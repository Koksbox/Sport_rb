{% extends 'base.html' %}
{% load static %}

{% block title %}Создать организацию - СпортБаш{% endblock %}

{% block extra_js %}
<script>
    // Передаём API ключ в JavaScript
    window.YANDEX_MAPS_API_KEY = '{{ YANDEX_MAPS_API_KEY|default:"" }}';
</script>
<script src="{% static 'js/yandex_maps_city_selector.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-organizations' %}" style="color: var(--primary-blue); text-decoration: none;">
            ← Вернуться к списку организаций
        </a>
    </div>
    
    <h1>Создать спортивную организацию</h1>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Информация об организации</h2>
        </div>
        <div class="card-body">
            <form id="createOrgForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div id="messages"></div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="name">Название организации *</label>
                        <input type="text" class="form-control" id="name" name="name" required 
                               placeholder="Например: ДЮСШ 'Олимпиец'">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="org_type">Тип организации *</label>
                        <select class="form-control" id="org_type" name="org_type" required>
                            <option value="">Выберите тип</option>
                            <option value="state">Государственная</option>
                            <option value="private">Частная</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="city_id">Город *</label>
                    <div id="citySelector"></div>
                    <small style="color: var(--text-light);">Выберите город из списка или на карте</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="address">Адрес *</label>
                    <input type="text" class="form-control" id="address" name="address" required
                           placeholder="Например: ул. Ленина, д. 10">
                    <small style="color: var(--text-light);">Укажите полный адрес организации</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Расположение на карте *</label>
                    <div id="mapContainer" style="height: 400px; margin-top: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px;">
                        <div style="padding: 1rem; text-align: center; color: var(--text-light);">
                            Выберите точку на карте для указания точного расположения организации
                        </div>
                    </div>
                    <small style="color: var(--text-light);">Обязательно укажите расположение на карте</small>
                    <input type="hidden" id="latitude" name="latitude" required>
                    <input type="hidden" id="longitude" name="longitude" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="inn">ИНН *</label>
                    <input type="text" class="form-control" id="inn" name="inn" required
                           placeholder="10 или 12 цифр" pattern="[0-9]{10}|[0-9]{12}" maxlength="12">
                    <small style="color: var(--text-light);">ИНН должен быть уникальным (10 или 12 цифр)</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="website">Сайт организации</label>
                    <input type="url" class="form-control" id="website" name="website" 
                           placeholder="https://example.com">
                    <small style="color: var(--text-light);">Необязательное поле</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Документы (лицензия, устав)</label>
                    <input type="file" class="form-control" id="documents" name="documents" multiple 
                           accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    <small style="color: var(--text-light);">Необязательное поле. Можно загрузить несколько файлов (PDF, DOC, изображения)</small>
                </div>
                
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <button type="submit" class="btn btn-primary" style="width: 100%;" id="submitBtn">
                        Создать организацию
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card" style="margin-top: 2rem; background: var(--secondary-blue);">
        <div class="card-body">
            <h3>Что дальше?</h3>
            <p>После создания организации она будет отправлена на модерацию. После одобрения вы автоматически получите роль "Директор" и сможете управлять организацией.</p>
        </div>
    </div>
</div>

<script>
// Инициализация селектора города
let citySelector = null;
let locationMap = null;
let locationMarker = null;

// Загружаем данные пользователя и инициализируем селектор
fetch('/api/users/basic-data/')
    .then(response => response.json())
    .then(userData => {
        // Получаем API ключ
        const apiKey = window.YANDEX_MAPS_API_KEY || '';
        
        // Инициализируем селектор города (без карты, так как карта отдельно)
        citySelector = window.createYandexCitySelector('citySelector', {
            apiKey: apiKey,
            showMap: false, // Карта будет отдельно для выбора расположения
            initialCity: userData.city || null,
            onCitySelect: function(city) {
                // При выборе города обновляем карту расположения
                if (locationMap && city && city.name) {
                    citySelector.geocodeCity(city.name).then(() => {
                        if (citySelector.selectedCoords) {
                            const coords = citySelector.selectedCoords;
                            locationMap.setCenter([coords.latitude, coords.longitude], 15);
                            updateLocationMarker([coords.latitude, coords.longitude]);
                        }
                    });
                }
            }
        });
        
        // Инициализируем карту для выбора расположения
        initLocationMap(apiKey, userData.city);
        
        // Если есть город в профиле, устанавливаем его
        if (userData.city) {
            setTimeout(() => {
                fetch(`/api/geography/cities/search/?q=${encodeURIComponent(userData.city)}`)
                    .then(response => response.json())
                    .then(results => {
                        if (results.length > 0 && citySelector) {
                            const input = document.getElementById('citySelector_input');
                            if (input) {
                                citySelector.selectCity(results[0], input);
                            }
                        }
                    });
            }, 500);
        }
    })
    .catch(error => {
        console.error('Ошибка загрузки данных пользователя:', error);
        const apiKey = window.YANDEX_MAPS_API_KEY || '';
        citySelector = window.createYandexCitySelector('citySelector', {
            apiKey: apiKey,
            showMap: false
        });
        initLocationMap(apiKey);
    });

// Инициализация карты для выбора расположения
function initLocationMap(apiKey, initialCity = null) {
    const mapContainer = document.getElementById('mapContainer');
    if (!mapContainer) return;
    
    if (!window.ymaps) {
        const script = document.createElement('script');
        script.src = `https://api-maps.yandex.ru/2.1/?apikey=${apiKey}&lang=ru_RU`;
        script.onload = () => {
            window.ymaps.ready(() => {
                createLocationMap(mapContainer, initialCity);
            });
        };
        document.head.appendChild(script);
    } else {
        window.ymaps.ready(() => {
            createLocationMap(mapContainer, initialCity);
        });
    }
}

function createLocationMap(container, initialCity = null) {
    // Начальные координаты (Уфа, если не указан город)
    let initialCoords = [54.7431, 55.9678];
    
    // Если есть начальный город, геокодируем его
    if (initialCity && citySelector) {
        citySelector.geocodeCity(initialCity).then(() => {
            if (citySelector.selectedCoords) {
                const coords = citySelector.selectedCoords;
                initialCoords = [coords.latitude, coords.longitude];
            }
            setupMap(container, initialCoords);
        });
    } else {
        setupMap(container, initialCoords);
    }
}

function setupMap(container, initialCoords) {
    locationMap = new window.ymaps.Map(container, {
        center: initialCoords,
        zoom: 15,
        controls: ['zoomControl', 'fullscreenControl', 'typeSelector']
    });
    
    // Маркер для выбранной точки
    locationMarker = new window.ymaps.Placemark(initialCoords, {
        balloonContent: 'Расположение организации'
    }, {
        draggable: true,
        preset: 'islands#blueDotIcon'
    });
    
    locationMap.geoObjects.add(locationMarker);
    
    // Устанавливаем начальные координаты
    updateLocationCoordinates(initialCoords);
    
    // Обработчик клика на карте
    locationMap.events.add('click', (e) => {
        const coords = e.get('coords');
        updateLocationMarker(coords);
        updateLocationCoordinates(coords);
    });
    
    // Обработчик перетаскивания маркера
    locationMarker.events.add('dragend', () => {
        const coords = locationMarker.geometry.getCoordinates();
        updateLocationCoordinates(coords);
    });
}

function updateLocationMarker(coords) {
    if (locationMarker) {
        locationMarker.geometry.setCoordinates(coords);
    } else if (locationMap) {
        locationMarker = new window.ymaps.Placemark(coords, {
            balloonContent: 'Расположение организации'
        }, {
            draggable: true,
            preset: 'islands#blueDotIcon'
        });
        locationMap.geoObjects.add(locationMarker);
    }
}

function updateLocationCoordinates(coords) {
    // coords в формате [широта, долгота]
    document.getElementById('latitude').value = coords[0];
    document.getElementById('longitude').value = coords[1];
}

// Обработка отправки формы
document.getElementById('createOrgForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messagesDiv = document.getElementById('messages');
    const submitBtn = document.getElementById('submitBtn');
    const form = this;
    
    // Очистка предыдущих сообщений
    messagesDiv.innerHTML = '';
    
    // Блокировка кнопки
    submitBtn.disabled = true;
    submitBtn.textContent = 'Создание...';
    
    // Создание FormData
    const formData = new FormData(form);
    
    // Добавляем данные из селектора города
    if (citySelector) {
        const cityData = citySelector.getSelectedCity();
        if (cityData && cityData.id) {
            formData.set('city_id', cityData.id);
        }
    }
    
    // Проверяем, что координаты указаны
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    
    if (!latitude || !longitude) {
        messagesDiv.innerHTML = '<div class="alert alert-error">Пожалуйста, укажите расположение организации на карте</div>';
        messagesDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        submitBtn.disabled = false;
        submitBtn.textContent = 'Создать организацию';
        return;
    }
    
    formData.set('latitude', latitude);
    formData.set('longitude', longitude);
    
    // Отправка запроса
    fetch('/api/organizations/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json().then(data => ({ status: response.status, data })))
    .then(result => {
        if (result.status === 201) {
            messagesDiv.innerHTML = '<div class="alert alert-success">' + 
                (result.data.message || 'Организация успешно создана!') + '</div>';
            setTimeout(() => {
                window.location.href = '/dashboard/';
            }, 2000);
        } else {
            // Обработка ошибок
            let errors = '';
            if (result.data.error) {
                errors = result.data.error;
            } else if (typeof result.data === 'object') {
                for (let key in result.data) {
                    const fieldNames = {
                        'name': 'Название организации',
                        'org_type': 'Тип организации',
                        'city_id': 'Город',
                        'address': 'Адрес',
                        'latitude': 'Широта (расположение на карте)',
                        'longitude': 'Долгота (расположение на карте)',
                        'inn': 'ИНН',
                        'website': 'Сайт'
                    };
                    const fieldName = fieldNames[key] || key;
                    
                    if (Array.isArray(result.data[key])) {
                        result.data[key].forEach(msg => {
                            errors += `${fieldName}: ${msg}<br>`;
                        });
                    } else if (typeof result.data[key] === 'object') {
                        for (let nestedKey in result.data[key]) {
                            errors += `${fieldName}.${nestedKey}: ${result.data[key][nestedKey]}<br>`;
                        }
                    } else {
                        errors += `${fieldName}: ${result.data[key]}<br>`;
                    }
                }
            } else {
                errors = 'Произошла ошибка при создании организации';
            }
            
            messagesDiv.innerHTML = '<div class="alert alert-error">' + errors + '</div>';
            messagesDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">Произошла ошибка при отправке формы. Попробуйте еще раз.</div>';
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Создать организацию';
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Валидация ИНН
document.getElementById('inn').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, ''); // Только цифры
});
</script>
{% endblock %}
