{% extends 'base.html' %}
{% load static %}
{% load role_names %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container">
    {% if all_roles|length > 1 %}
    <div class="card" style="margin-bottom: 1.5rem; background: var(--secondary-blue);">
        <div class="card-body">
            <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–æ–ª–∏</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% for role in all_roles %}
                <button class="role-switch-btn {% if role == active_role %}active{% endif %}" 
                        onclick="switchRole('{{ role }}')" 
                        data-role="{{ role }}">
                    {{ role|role_name }}
                </button>
                {% endfor %}
                {% if all_roles|length < 4 %}
                <button class="role-switch-btn" onclick="window.location.href='{% url 'frontend-new-role-selection' %}'" 
                        style="background: var(--primary-blue); color: white;">
                    + –î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif all_roles|length == 1 %}
    <div class="card" style="margin-bottom: 1.5rem; background: var(--secondary-blue);">
        <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>–£ –≤–∞—Å –æ–¥–Ω–∞ —Ä–æ–ª—å. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë?</span>
                {% if all_roles|length < 4 %}
                <a href="{% url 'frontend-new-role-selection' %}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <h1>üèãÔ∏è –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞</h1>
    
    {% if user.coach_profile %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        </div>
        <div class="card-body">
            <div class="profile-info">
                <div class="profile-item">
                    <span class="profile-label">–§–ò–û:</span>
                    <span class="profile-value">{{ user.get_full_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Email:</span>
                    <span class="profile-value">{{ user.email }}</span>
                </div>
                {% if user.coach_profile.city %}
                <div class="profile-item">
                    <span class="profile-label">–ì–æ—Ä–æ–¥:</span>
                    <span class="profile-value">{{ user.coach_profile.city.name }}</span>
                </div>
                {% endif %}
                {% if user.coach_profile.specialization %}
                <div class="profile-item">
                    <span class="profile-label">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</span>
                    <span class="profile-value">{{ user.coach_profile.specialization.name }}</span>
                </div>
                {% endif %}
                {% if user.coach_profile.experience_years %}
                <div class="profile-item">
                    <span class="profile-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã:</span>
                    <span class="profile-value">{{ user.coach_profile.experience_years }} –ª–µ—Ç</span>
                </div>
                {% endif %}
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="{% url 'frontend-user-basic-data-edit' %}" class="btn btn-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ</a>
                <a href="{% url 'frontend-coach-profile-edit' %}" class="btn btn-primary">üèãÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Ç—Ä–µ–Ω–µ—Ä–∞</a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- –ú–æ–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
    {% if user.coach_profile %}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">–ú–æ–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h2>
        </div>
        <div class="card-body">
            <div id="coachOrganizations">
                <div class="loading" style="margin: 2rem auto; display: block;"></div>
            </div>
            <div style="margin-top: 1rem;">
                <a href="{% url 'frontend-coach-find-organization' %}" class="btn btn-primary">üîç –ù–∞–π—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã</a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- –ú–æ–∏ –≥—Ä—É–ø–ø—ã -->
    {% if user.coach_profile %}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">–ú–æ–∏ –≥—Ä—É–ø–ø—ã</h2>
        </div>
        <div class="card-body">
            <div id="coachGroups">
                <div class="loading" style="margin: 2rem auto; display: block;"></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="section-header" style="margin-top: 2rem;">
        <h2 class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
    </div>
    <div class="grid grid-2">
        <a href="{% url 'frontend-coach-groups' %}" class="item-card">
            <div class="item-icon">üë•</div>
            <h3 class="item-card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h3>
            <p class="item-card-description">–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ –∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</p>
        </a>
        
        <a href="{% url 'frontend-coach-find-organization' %}" class="item-card">
            <div class="item-icon">üîç</div>
            <h3 class="item-card-title">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
            <p class="item-card-description">–ù–∞–π—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</p>
        </a>
        
        <a href="{% url 'frontend-coach-invitations' %}" class="item-card">
            <div class="item-icon">üì®</div>
            <h3 class="item-card-title">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h3>
            <p class="item-card-description">–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</p>
        </a>
        
        <a href="{% url 'frontend-events' %}" class="item-card">
            <div class="item-icon">üèÜ</div>
            <h3 class="item-card-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
            <p class="item-card-description">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞(-–æ–≤) –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
        </a>
    </div>
</div>

<script>
function switchRole(role) {
    fetch('/api/users/switch-role/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ role: role })
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200 && result.data.success) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            window.location.href = '/dashboard/';
        } else {
            alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–æ–ª–∏: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–æ–ª–∏');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —Ç—Ä–µ–Ω–µ—Ä–∞
fetch('/api/coaches/organizations/', {
    headers: {
        'X-CSRFToken': getCookie('csrftoken')
    }
})
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const container = document.getElementById('coachOrganizations');
        if (data.organizations && data.organizations.length > 0) {
            let html = '<div class="grid grid-2" style="gap: 1rem;">';
            data.organizations.forEach(org => {
                html += `
                    <div class="card" style="padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">${escapeHtml(org.name)}</h4>
                        <p style="color: var(--text-light); margin-bottom: 0.5rem;">${escapeHtml(org.city_name || '')}</p>
                        <a href="/coaches/organizations/${org.id}/groups/" class="btn btn-secondary" style="width: 100%;">–£–ø—Ä–∞–≤–ª—è—Ç—å –≥—Ä—É–ø–ø–∞–º–∏</a>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
        const container = document.getElementById('coachOrganizations');
        if (container) {
            container.innerHTML = '<p style="color: var(--text-error); text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>';
        }
    });

// –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø —Ç—Ä–µ–Ω–µ—Ä–∞
fetch('/api/coaches/groups/')
    .then(response => response.json())
    .then(groups => {
        const container = document.getElementById('coachGroups');
        if (groups && groups.length > 0) {
            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            groups.forEach(group => {
                html += `
                    <div class="card" style="padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin-bottom: 0.5rem;">${escapeHtml(group.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h4>
                                <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                                    ${escapeHtml(group.organization_name || '')} ‚Ä¢ ${escapeHtml(group.sport_name || '')}
                                </p>
                                <p style="color: var(--text-light);">–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤: ${group.enrollments ? group.enrollments.length : 0}</p>
                            </div>
                            <a href="/coaches/groups/${group.id}/" class="btn btn-primary">–û—Ç–∫—Ä—ã—Ç—å</a>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
        document.getElementById('coachGroups').innerHTML = 
            '<p style="color: var(--text-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</p>';
    });

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<style>
.role-switch-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--primary-blue);
    border-radius: var(--border-radius);
    background: white;
    color: var(--primary-blue);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.role-switch-btn:hover {
    background: var(--primary-blue);
    color: white;
}

.role-switch-btn.active {
    background: var(--primary-blue);
    color: white;
}
</style>
{% endblock %}
