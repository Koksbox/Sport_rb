{% extends 'base.html' %}
{% load static %}

{% block title %}–ù–æ–≤–æ—Å—Ç–∏ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <h1>üì∞ –ù–æ–≤–æ—Å—Ç–∏</h1>
    
    <div id="newsList">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
</div>

<script>
function loadNews() {
    const container = document.getElementById('newsList');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ API
    fetch('/api/core/news/')
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (response.ok) {
                renderNews(data);
            } else {
                throw new Error(data.error || data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π');
            }
        } else {
            throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
        container.innerHTML = '<p style="color: var(--error); text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π: ' + escapeHtml(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
    });
}

function renderNews(news) {
    const container = document.getElementById('newsList');
    
    if (news.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 3rem;">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 1.5rem;">';
    news.forEach(item => {
        const date = item.published_at ? new Date(item.published_at).toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : '';
        
        html += `
            <div class="card" style="cursor: pointer;" onclick="window.location.href='/news/${item.slug || item.id}/'">
                ${item.image ? `<img src="${item.image}" alt="${escapeHtml(item.title)}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px 8px 0 0;">` : ''}
                <div class="card-header">
                    <h3 style="margin: 0;">${escapeHtml(item.title)}</h3>
                    ${date ? `<span style="color: var(--text-light); font-size: 0.9rem;">${date}</span>` : ''}
                </div>
                <div class="card-body">
                    ${item.excerpt ? `<p style="color: var(--text-light); margin-bottom: 0.5rem;">${escapeHtml(item.excerpt)}</p>` : ''}
                    <p style="white-space: pre-wrap;">${escapeHtml(item.content || '').substring(0, 200)}${item.content && item.content.length > 200 ? '...' : ''}</p>
                    ${item.author_name ? `<p style="color: var(--text-light); font-size: 0.9rem; margin-top: 0.5rem;">–ê–≤—Ç–æ—Ä: ${escapeHtml(item.author_name)}</p>` : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', function() {
    loadNews();
});
</script>
{% endblock %}
