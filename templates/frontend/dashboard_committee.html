{% extends 'base.html' %}
{% load static %}
{% load role_names %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å–ø–æ—Ä—Ç–∫–æ–º–∏—Ç–µ—Ç–∞ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px;">
    <!-- –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="user-profile-card">
        <div class="user-profile-header">
            <h2>–û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ</h2>
            <div class="user-profile-actions">
                <a href="{% url 'frontend-user-basic-data-edit' %}" class="btn btn-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            </div>
        </div>
        <div class="user-profile-content">
            <div class="profile-info">
                <div class="profile-item">
                    <span class="profile-label">–§–ò–û:</span>
                    <span class="profile-value">{{ user.get_full_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">Email:</span>
                    <span class="profile-value">{{ user.email }}</span>
                </div>
                {% if user.phone %}
                <div class="profile-item">
                    <span class="profile-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                    <span class="profile-value">{{ user.phone }}</span>
                </div>
                {% endif %}
                {% if user.committee_role %}
                <div class="profile-item">
                    <span class="profile-label">–ì–æ—Ä–æ–¥:</span>
                    <span class="profile-value">{{ user.committee_role.city.name }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–æ–ª–µ–π -->
    {% if all_roles|length > 1 %}
        {% include 'frontend/dashboard_parts/role_switcher.html' %}
    {% elif all_roles|length == 1 %}
    <div class="card" style="margin-bottom: 2rem; background: var(--secondary-blue);">
        <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <span>–£ –≤–∞—Å –æ–¥–Ω–∞ —Ä–æ–ª—å. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë?</span>
                {% if all_roles|length < 4 %}
                <a href="{% url 'frontend-new-role-selection' %}" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- –í–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    {% include 'frontend/dashboard_parts/notifications_widget.html' %}
    
    <h1>üèõÔ∏è –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å–ø–æ—Ä—Ç–∫–æ–º–∏—Ç–µ—Ç–∞</h1>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</h2>
        </div>
        <div class="card-body">
            <div id="organizationsStats">
                <div class="loading" style="margin: 2rem auto; display: block;"></div>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn btn-primary" onclick="loadOrganizationsStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            </div>
        </div>
    </div>
    
    <!-- –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h2>
        </div>
        <div class="card-body">
            <form id="createEventForm">
                <div class="form-group">
                    <label class="form-label" for="eventTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è *</label>
                    <input type="text" class="form-control" id="eventTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="eventDescription">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                    <textarea class="form-control" id="eventDescription" name="description" rows="4" required></textarea>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="eventType">–¢–∏–ø –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è *</label>
                        <select class="form-control" id="eventType" name="event_type" required>
                            <option value="competition">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ</option>
                            <option value="marathon">–ú–∞—Ä–∞—Ñ–æ–Ω</option>
                            <option value="gto_festival">–§–µ—Å—Ç–∏–≤–∞–ª—å –ì–¢–û</option>
                            <option value="open_doors">–î–Ω–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π</option>
                            <option value="camp">–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –ª–∞–≥–µ—Ä—å</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="eventLevel">–£—Ä–æ–≤–µ–Ω—å *</label>
                        <select class="form-control" id="eventLevel" name="level" required>
                            <option value="school">–®–∫–æ–ª—å–Ω—ã–π</option>
                            <option value="district">–†–∞–π–æ–Ω–Ω—ã–π</option>
                            <option value="city">–ì–æ—Ä–æ–¥—Å–∫–æ–π</option>
                            <option value="republic">–†–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Å–∫–∏–π</option>
                            <option value="national">–í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="eventVenue">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è *</label>
                    <input type="text" class="form-control" id="eventVenue" name="venue" required>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="eventStartDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                        <input type="datetime-local" class="form-control" id="eventStartDate" name="start_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="eventEndDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="datetime-local" class="form-control" id="eventEndDate" name="end_date">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="requires_registration" checked>
                        –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </label>
                </div>
                <div id="createEventMessages" style="margin-top: 1rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
            </form>
        </div>
    </div>
    
    <!-- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 class="card-title">–ì–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
        </div>
        <div class="card-body">
            <form id="globalNotificationForm">
                <div class="form-group">
                    <label class="form-label" for="notificationTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                    <input type="text" class="form-control" id="notificationTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="notificationBody">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è *</label>
                    <textarea class="form-control" id="notificationBody" name="body" rows="5" required></textarea>
                </div>
                <div id="globalNotificationMessages" style="margin-top: 1rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</button>
            </form>
        </div>
    </div>
</div>

<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
function loadOrganizationsStats() {
    const container = document.getElementById('organizationsStats');
    container.innerHTML = '<div class="loading" style="margin: 2rem auto; display: block;"></div>';
    
    fetch('/api/city-committee/organizations/statistics/')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.organizations && data.organizations.length > 0) {
            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            data.organizations.forEach(org => {
                html += `
                    <div class="card" style="cursor: pointer;" onclick="showOrgDetails(${org.id})">
                        <div class="card-body">
                            <h3 style="margin-bottom: 0.5rem;">${escapeHtml(org.name)}</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                                <div>
                                    <span style="color: var(--text-light);">–°–ø–æ—Ä—Ç—Å–º–µ–Ω—ã:</span>
                                    <strong style="display: block; font-size: 1.2rem;">${org.athletes_count || 0}</strong>
                                </div>
                                <div>
                                    <span style="color: var(--text-light);">–¢—Ä–µ–Ω–µ—Ä—ã:</span>
                                    <strong style="display: block; font-size: 1.2rem;">${org.coaches_count || 0}</strong>
                                </div>
                                <div>
                                    <span style="color: var(--text-light);">–ì—Ä—É–ø–ø—ã:</span>
                                    <strong style="display: block; font-size: 1.2rem;">${org.groups_count || 0}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center;">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        container.innerHTML = '<p style="color: var(--error); text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>';
    });
}

function showOrgDetails(orgId) {
    fetch(`/api/city-committee/organizations/${orgId}/statistics/`)
    .then(response => response.json())
    .then(data => {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${escapeHtml(data.organization.name)}</h3>
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="stat-card">
                            <div class="stat-value">${data.statistics.athletes_count}</div>
                            <div class="stat-label">–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.statistics.coaches_count}</div>
                            <div class="stat-label">–¢—Ä–µ–Ω–µ—Ä–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.statistics.groups_count}</div>
                            <div class="stat-label">–ì—Ä—É–ø–ø</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.statistics.attendance_rate}%</div>
                            <div class="stat-label">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                        <p><strong>–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π:</strong> ${data.statistics.total_sessions}</p>
                        <p><strong>–ü–æ—Å–µ—â–µ–Ω–æ:</strong> ${data.statistics.attended_sessions}</p>
                        <p><strong>–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:</strong> ${data.statistics.upcoming_events}</p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.style.display = 'block';
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
    });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
document.getElementById('createEventForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const messagesDiv = document.getElementById('createEventMessages');
    messagesDiv.innerHTML = '<div class="alert alert-info">–°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è...</div>';
    
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç ISO
    if (data.start_date) {
        data.start_date = new Date(data.start_date).toISOString();
    }
    if (data.end_date) {
        data.end_date = new Date(data.end_date).toISOString();
    }
    data.requires_registration = formData.has('requires_registration');
    
    fetch('/api/city-committee/events/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json().then(data => ({ status: response.status, data })))
    .then(result => {
        if (result.status === 201) {
            messagesDiv.innerHTML = '<div class="alert alert-success">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!</div>';
            this.reset();
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 3000);
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + (result.data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è') + '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>';
    });
});

// –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
document.getElementById('globalNotificationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const messagesDiv = document.getElementById('globalNotificationMessages');
    const title = document.getElementById('notificationTitle').value.trim();
    const body = document.getElementById('notificationBody').value.trim();
    
    if (!title || !body) {
        messagesDiv.innerHTML = '<div class="alert alert-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</div>';
        return;
    }
    
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–∏—Å—Ç–µ–º—ã?')) {
        return;
    }
    
    messagesDiv.innerHTML = '<div class="alert alert-info">–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...</div>';
    
    fetch('/api/city-committee/notifications/global/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ title, body })
    })
    .then(response => response.json().then(data => ({ status: response.status, data })))
    .then(result => {
        if (result.status === 201) {
            messagesDiv.innerHTML = '<div class="alert alert-success">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ' + result.data.recipients_count + ' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!</div>';
            this.reset();
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 3000);
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + (result.data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è') + '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>';
    });
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadOrganizationsStats();
});

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.stat-card {
    background: var(--light-gray);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-blue);
}

.stat-label {
    color: var(--text-light);
    font-size: 0.9rem;
    margin-top: 0.5rem;
}
</style>
{% endblock %}
