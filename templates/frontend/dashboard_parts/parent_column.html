{% load static %}

<!-- –ú–æ–∏ –¥–µ—Ç–∏ -->
<div class="role-section">
    <div class="role-section-header">
        <h3>–ú–æ–∏ –¥–µ—Ç–∏</h3>
    </div>
    <div class="role-section-content">
        <div id="parentChildren-{{ role_index }}">
            <div class="loading" style="margin: 1rem auto; display: block;"></div>
        </div>
        <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="window['showAddChildModal_{{ role_index }}']()" style="width: 100%;">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ –ø–æ ID
            </button>
            <button class="btn btn-secondary" onclick="window['showAddChildQR_{{ role_index }}']()" style="width: 100%;">
                üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞ -->
<div id="addChildModal-{{ role_index }}" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</h3>
            <span class="close" onclick="window['closeAddChildModal_{{ role_index }}']()">&times;</span>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 1rem; color: var(--text-light); font-size: 0.9rem;">
                –í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ä–æ–ª–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –≤–∞—à–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞.
            </p>
            <div class="form-group">
                <label class="form-label" for="childRoleId-{{ role_index }}">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ä–æ–ª–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞</label>
                <input type="text" class="form-control" id="childRoleId-{{ role_index }}" 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A1B2C3D4" maxlength="8">
            </div>
            <div id="addChildMessages-{{ role_index }}" style="margin-top: 1rem;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="window['closeAddChildModal_{{ role_index }}']()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="window['sendChildRequest_{{ role_index }}']()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>
</div>

<script>
(function() {
    const roleIndex = {{ role_index|default:0 }};
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–µ–π
    function loadChildren() {
        const container = document.getElementById('parentChildren-' + roleIndex);
        if (!container) {
            console.error('Container not found: parentChildren-' + roleIndex);
            return;
        }
        
        const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function() { return ''; };
        
        fetch('/api/parents/children/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookieFunc('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || data.message || `HTTP ${response.status}`);
                }).catch(() => {
                    throw new Error(`HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (!Array.isArray(data)) {
                console.error('Invalid data format:', data);
                container.innerHTML = '<p style="color: var(--error); text-align: center; font-size: 0.9rem;">–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö</p>';
                return;
            }
            
            if (data.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; font-size: 0.9rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–µ—Ç–µ–π.</p>';
                return;
            }
            
            const escapeHtml = window.escapeHtml || function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            data.forEach(child => {
                const fullName = child.full_name || (child.first_name && child.last_name ? child.first_name + ' ' + child.last_name : '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
                html += `
                    <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                        <h4 style="margin-bottom: 0.25rem; font-size: 1rem;">${escapeHtml(fullName)}</h4>
                        <p style="color: var(--text-light); font-size: 0.875rem;">
                            ${child.main_sport_name ? 'üèÉ ' + escapeHtml(child.main_sport_name) : ''}
                        </p>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–µ–π:', error);
            if (container) {
                container.innerHTML = '<p style="color: var(--error); text-align: center; font-size: 0.9rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
            }
        });
    }
    
    loadChildren();
    
    // –°–æ–∑–¥–∞—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —ç—Ç–æ–π —Ä–æ–ª–∏
    const showModalFunc = 'showAddChildModal_' + roleIndex;
    const closeModalFunc = 'closeAddChildModal_' + roleIndex;
    const sendRequestFunc = 'sendChildRequest_' + roleIndex;
    const showQRFunc = 'showAddChildQR_' + roleIndex;
    
    window[showModalFunc] = function() {
        const modal = document.getElementById('addChildModal-' + roleIndex);
        const input = document.getElementById('childRoleId-' + roleIndex);
        const messages = document.getElementById('addChildMessages-' + roleIndex);
        if (modal) modal.style.display = 'block';
        if (input) input.value = '';
        if (messages) messages.innerHTML = '';
    };
    
    window[closeModalFunc] = function() {
        const modal = document.getElementById('addChildModal-' + roleIndex);
        if (modal) modal.style.display = 'none';
    };
    
    window[sendRequestFunc] = function() {
        const roleIdInput = document.getElementById('childRoleId-' + roleIndex);
        const messagesDiv = document.getElementById('addChildMessages-' + roleIndex);
        
        if (!roleIdInput || !messagesDiv) {
            console.error('Elements not found');
            return;
        }
        
        const roleId = roleIdInput.value.trim().toUpperCase();
        const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };
        
        if (!roleId || roleId.length !== 8) {
            messagesDiv.innerHTML = '<div class="alert alert-error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID (8 —Å–∏–º–≤–æ–ª–æ–≤)</div>';
            return;
        }
        
        messagesDiv.innerHTML = '<div class="alert alert-info">–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏...</div>';
        
        fetch('/api/parents/children/request/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookieFunc('csrftoken')
            },
            body: JSON.stringify({ role_unique_id: roleId })
        })
        .then(response => {
            return response.json().then(data => ({ status: response.status, data })).catch(() => {
                return { status: response.status, data: { error: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞' } };
            });
        })
        .then(result => {
            if (result.status === 200 || result.status === 201) {
                messagesDiv.innerHTML = '<div class="alert alert-success">' + (result.data.message || '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞') + '</div>';
                setTimeout(() => {
                    window[closeModalFunc]();
                    loadChildren();
                }, 2000);
            } else {
                const errorMsg = result.data.error || result.data.message || result.data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏';
                messagesDiv.innerHTML = '<div class="alert alert-error">' + errorMsg + '</div>';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
        });
    };
    
    window[showQRFunc] = function() {
        // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'qrScannerModal-' + roleIndex;
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</h3>
                    <span class="close" onclick="closeQRScanner(${roleIndex})">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="qrScanner-${roleIndex}" style="text-align: center; padding: 2rem;">
                        <p style="margin-bottom: 1rem; color: var(--text-light);">
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–º–µ—Ä—É –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞ —Å ID —Ä–æ–ª–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞
                        </p>
                        <video id="qrVideo-${roleIndex}" style="width: 100%; max-width: 400px; border-radius: 8px; display: none;"></video>
                        <canvas id="qrCanvas-${roleIndex}" style="display: none;"></canvas>
                        <div id="qrScannerStatus-${roleIndex}">
                            <button class="btn btn-primary" onclick="startQRScanner(${roleIndex})">
                                üì∑ –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                            </button>
                        </div>
                        <div id="qrScannerResult-${roleIndex}" style="margin-top: 1rem; display: none;">
                            <div class="alert alert-info">ID –Ω–∞–π–¥–µ–Ω: <strong id="scannedId-${roleIndex}"></strong></div>
                            <button class="btn btn-primary" onclick="useScannedId(${roleIndex})" style="width: 100%; margin-top: 0.5rem;">
                                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç ID
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.style.display = 'block';
    };
    
    window['startQRScanner_' + roleIndex] = function() {
        const video = document.getElementById('qrVideo-' + roleIndex);
        const canvas = document.getElementById('qrCanvas-' + roleIndex);
        const status = document.getElementById('qrScannerStatus-' + roleIndex);
        const result = document.getElementById('qrScannerResult-' + roleIndex);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–∞–º–µ—Ä—ã
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(function(stream) {
                video.srcObject = stream;
                video.style.display = 'block';
                status.innerHTML = '<p style="color: var(--text-light);">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥</p>';
                
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ QR-–∫–æ–¥–∞ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É jsQR)
                const checkQR = setInterval(() => {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞
                    // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ API
                }, 500);
                
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É jsQR
                if (typeof jsQR !== 'undefined') {
                    const context = canvas.getContext('2d');
                    const checkQR = setInterval(() => {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);
                            
                            if (code) {
                                clearInterval(checkQR);
                                video.srcObject.getTracks().forEach(track => track.stop());
                                video.style.display = 'none';
                                document.getElementById('scannedId-' + roleIndex).textContent = code.data;
                                result.style.display = 'block';
                                window['scannedRoleId_' + roleIndex] = code.data;
                            }
                        }
                    }, 100);
                } else {
                    status.innerHTML = '<p style="color: var(--text-light);">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.</p>';
                }
            })
            .catch(function(err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
                status.innerHTML = '<div class="alert alert-error">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ ID.</div>';
            });
        } else {
            status.innerHTML = '<div class="alert alert-error">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ ID.</div>';
        }
    };
    
    window['useScannedId_' + roleIndex] = function() {
        const scannedId = window['scannedRoleId_' + roleIndex];
        if (scannedId) {
            window['closeQRScanner_' + roleIndex]();
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            const input = document.getElementById('childRoleId-' + roleIndex);
            if (input) input.value = scannedId;
            window[showModalFunc]();
            setTimeout(() => {
                window[sendRequestFunc]();
            }, 100);
        }
    };
    
    window['closeQRScanner_' + roleIndex] = function() {
        const modal = document.getElementById('qrScannerModal-' + roleIndex);
        const video = document.getElementById('qrVideo-' + roleIndex);
        if (video && video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        if (modal) {
            modal.remove();
        }
    };
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ onclick (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    // –ù–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ window[funcName]
    if (!window.showAddChildModal) {
        window.showAddChildModal = window[showModalFunc];
        window.closeAddChildModal = window[closeModalFunc];
        window.sendChildRequest = window[sendRequestFunc];
        window.showAddChildQR = window[showQRFunc];
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    const modal = document.getElementById('addChildModal-' + roleIndex);
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                window[closeModalFunc]();
            }
        });
    }
})();
</script>
