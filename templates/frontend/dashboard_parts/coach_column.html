{% load static %}

<!-- –ü—Ä–æ—Ñ–∏–ª—å —Ç—Ä–µ–Ω–µ—Ä–∞ -->
{% if user.coach_profile %}
<div class="role-section">
    <div class="role-section-header">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å —Ç—Ä–µ–Ω–µ—Ä–∞</h3>
    </div>
    <div class="role-section-content">
        <div class="profile-info">
            {% if user.coach_profile.city %}
            <div class="profile-item">
                <span class="profile-label">–ì–æ—Ä–æ–¥:</span>
                <span class="profile-value">{{ user.coach_profile.city.name }}</span>
            </div>
            {% endif %}
            {% if user.coach_profile.specialization %}
            <div class="profile-item">
                <span class="profile-label">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</span>
                <span class="profile-value">{{ user.coach_profile.specialization.name }}</span>
            </div>
            {% endif %}
            {% if user.coach_profile.experience_years %}
            <div class="profile-item">
                <span class="profile-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã:</span>
                <span class="profile-value">{{ user.coach_profile.experience_years }} –ª–µ—Ç</span>
            </div>
            {% endif %}
        </div>
        <div style="margin-top: 1rem;">
            <a href="{% url 'frontend-coach-profile-edit' %}" class="btn btn-primary" style="width: 100%;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
</div>
{% endif %}

<!-- –ú–æ–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
<div class="role-section">
    <div class="role-section-header">
        <h3>–ú–æ–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
    </div>
    <div class="role-section-content">
        <div id="coachOrganizations-{{ role_index }}">
            <div class="loading" style="margin: 1rem auto; display: block;"></div>
        </div>
        <div style="margin-top: 1rem;">
            <a href="{% url 'frontend-coach-find-organization' %}" class="btn btn-primary" style="width: 100%;">
                üîç –ù–∞–π—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã
            </a>
        </div>
    </div>
</div>

<!-- –ú–æ–∏ –≥—Ä—É–ø–ø—ã -->
<div class="role-section">
    <div class="role-section-header">
        <h3>–ú–æ–∏ –≥—Ä—É–ø–ø—ã</h3>
    </div>
    <div class="role-section-content">
        <div id="coachGroups-{{ role_index }}">
            <div class="loading" style="margin: 1rem auto; display: block;"></div>
        </div>
    </div>
</div>

<script>
(function() {
    const roleIndex = {{ role_index|default:0 }};
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —Ç—Ä–µ–Ω–µ—Ä–∞
    fetch('/api/coaches/organizations/', {
        headers: {
            'X-CSRFToken': getCookieFunc('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const container = document.getElementById('coachOrganizations-' + roleIndex);
        if (data.organizations && data.organizations.length > 0) {
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            data.organizations.forEach(org => {
                html += `
                    <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                        <h4 style="margin-bottom: 0.25rem; font-size: 1rem;">${escapeHtml(org.name)}</h4>
                        <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem;">${escapeHtml(org.city_name || '')}</p>
                        <a href="/coaches/organizations/${org.id}/groups/" class="btn btn-secondary" style="width: 100%; font-size: 0.875rem; padding: 0.5rem;">–£–ø—Ä–∞–≤–ª—è—Ç—å –≥—Ä—É–ø–ø–∞–º–∏</a>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center; font-size: 0.9rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
        const container = document.getElementById('coachOrganizations-' + roleIndex);
        if (container) {
            container.innerHTML = '<p style="color: var(--error); text-align: center; font-size: 0.9rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø —Ç—Ä–µ–Ω–µ—Ä–∞
    fetch('/api/coaches/groups/')
    .then(response => response.json())
    .then(groups => {
        const container = document.getElementById('coachGroups-' + roleIndex);
        if (groups && groups.length > 0) {
            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            groups.forEach(group => {
                html += `
                    <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                        <h4 style="margin-bottom: 0.25rem; font-size: 1rem;">${escapeHtml(group.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h4>
                        <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem;">
                            ${escapeHtml(group.organization_name || '')} ‚Ä¢ ${escapeHtml(group.sport_name || '')}
                        </p>
                        <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem;">–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤: ${group.enrollments ? group.enrollments.length : 0}</p>
                        <a href="/coaches/groups/${group.id}/" class="btn btn-primary" style="width: 100%; font-size: 0.875rem; padding: 0.5rem;">–û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: var(--text-light); text-align: center; font-size: 0.9rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø</p>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
        const container = document.getElementById('coachGroups-' + roleIndex);
        if (container) {
            container.innerHTML = '<p style="color: var(--error); text-align: center; font-size: 0.9rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
        }
    });
})();

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é getCookie –∏–∑ main.js
const getCookieFunc = window.getCookie || window.SportBash?.getCookie || function(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
};
</script>
