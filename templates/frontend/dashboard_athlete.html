{% extends 'base.html' %}
{% load static %}
{% load role_names %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container">
    {% if all_roles|length > 1 %}
    <div class="card" style="margin-bottom: 1.5rem; background: var(--secondary-blue);">
        <div class="card-body">
            <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–æ–ª–∏</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% for role in all_roles %}
                <button class="role-switch-btn {% if role == active_role %}active{% endif %}" 
                        onclick="switchRole('{{ role }}')" 
                        data-role="{{ role }}">
                    {{ role|role_name }}
                </button>
                {% endfor %}
                {% if all_roles|length < 4 %}
                <button class="role-switch-btn" onclick="window.location.href='{% url 'frontend-new-role-selection' %}'" 
                        style="background: var(--primary-blue); color: white;">
                    + –î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif all_roles|length == 1 %}
    <div class="card" style="margin-bottom: 1.5rem; background: var(--secondary-blue);">
        <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>–£ –≤–∞—Å –æ–¥–Ω–∞ —Ä–æ–ª—å. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë?</span>
                {% if all_roles|length < 4 %}
                <a href="{% url 'frontend-new-role-selection' %}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <h1>üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞</h1>
    
    {% if user.athlete_profile %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                {% if user.photo %}
                <div style="flex-shrink: 0;">
                    <img src="{{ user.photo.url }}" alt="–§–æ—Ç–æ" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-blue);">
                </div>
                {% endif %}
                <div style="flex: 1; min-width: 300px;">
                    <div class="profile-info">
                        <div class="profile-item">
                            <span class="profile-label">–§–ò–û:</span>
                            <span class="profile-value">{{ user.get_full_name }}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">Email:</span>
                            <span class="profile-value">{{ user.email }}</span>
                        </div>
                        {% if user.athlete_profile.city %}
                        <div class="profile-item">
                            <span class="profile-label">–ì–æ—Ä–æ–¥:</span>
                            <span class="profile-value">{{ user.athlete_profile.city.name }}</span>
                        </div>
                        {% endif %}
                        {% if user.athlete_profile.main_sport %}
                        <div class="profile-item">
                            <span class="profile-label">–û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥ —Å–ø–æ—Ä—Ç–∞:</span>
                            <span class="profile-value">{{ user.athlete_profile.main_sport.name }}</span>
                        </div>
                        {% endif %}
                        {% if user.athlete_profile.specializations.exists %}
                        <div class="profile-item">
                            <span class="profile-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞:</span>
                            <span class="profile-value">
                                {% for spec in user.athlete_profile.specializations.all %}
                                    {% if not spec.is_primary %}
                                        {{ spec.sport.name }}{% if not forloop.last %}, {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                        {% if user.athlete_profile.health_group %}
                        <div class="profile-item">
                            <span class="profile-label">–ì—Ä—É–ø–ø–∞ –∑–¥–æ—Ä–æ–≤—å—è:</span>
                            <span class="profile-value">{{ user.athlete_profile.health_group }}</span>
                        </div>
                        {% endif %}
                        {% if user.athlete_profile.goals %}
                        <div class="profile-item">
                            <span class="profile-label">–¶–µ–ª–∏:</span>
                            <span class="profile-value">{{ user.athlete_profile.goals|join:", " }}</span>
                        </div>
                        {% endif %}
                        <div class="profile-item" id="roleIdItem" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <span class="profile-label">–ú–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID:</span>
                            <span class="profile-value" id="roleIdValue" style="font-weight: bold; font-size: 1.2rem; color: var(--primary-blue); font-family: monospace;"></span>
                            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                üìã –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º ID —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∞—Å –≤ —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π
                            </small>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="{% url 'frontend-user-basic-data-edit' %}" class="btn btn-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ</a>
                            <a href="{% url 'frontend-athlete-profile-edit' %}" class="btn btn-primary">üèÉ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ä–æ–ª–∏
    fetch('/api/parents/my-role-id/')
        .then(response => response.json())
        .then(data => {
            if (data.unique_id) {
                document.getElementById('roleIdValue').textContent = data.unique_id;
                document.getElementById('roleIdItem').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ID —Ä–æ–ª–∏:', error);
        });
    </script>
    {% endif %}
    
    <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
            <h2 class="card-title">üìä –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h2>
        </div>
        <div class="card-body">
            <div id="progressChart" style="min-height: 300px;">
                <div class="loading" style="margin: 2rem auto; display: block;"></div>
            </div>
        </div>
    </div>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="section-header" style="margin-top: 2rem;">
        <h2 class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
    </div>
    <div class="grid grid-2">
        <a href="{% url 'frontend-organizations' %}" class="item-card">
            <div class="item-icon">üè¢</div>
            <h3 class="item-card-title">–ù–∞–π—Ç–∏ —Å–µ–∫—Ü–∏—é</h3>
            <p class="item-card-description">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ —Å–ø–æ—Ä—Ç–∏–≤–Ω—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</p>
        </a>
        
        <a href="{% url 'frontend-events' %}" class="item-card">
            <div class="item-icon">üèÜ</div>
            <h3 class="item-card-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
            <p class="item-card-description">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
fetch('/api/athletes/progress/')
    .then(response => response.json())
    .then(data => {
        const ctx = document.createElement('canvas');
        document.getElementById('progressChart').innerHTML = '';
        document.getElementById('progressChart').appendChild(ctx);
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø–æ –º–µ—Å—è—Ü–∞–º
        const attendanceByMonth = {};
        if (data.attendance) {
            data.attendance.forEach(record => {
                const month = new Date(record.date).toLocaleDateString('ru-RU', { month: 'short', year: 'numeric' });
                if (!attendanceByMonth[month]) {
                    attendanceByMonth[month] = { present: 0, absent: 0, late: 0 };
                }
                if (record.status === 'present') attendanceByMonth[month].present++;
                else if (record.status === 'absent') attendanceByMonth[month].absent++;
                else if (record.status === 'late') attendanceByMonth[month].late++;
            });
        }
        
        const months = Object.keys(attendanceByMonth).sort();
        const presentData = months.map(m => attendanceByMonth[m].present);
        const absentData = months.map(m => attendanceByMonth[m].absent);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: '–ü–æ—Å–µ—â–µ–Ω–∏—è',
                        data: presentData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    },
                    {
                        label: '–ü—Ä–æ–ø—É—Å–∫–∏',
                        data: absentData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const statsHtml = `
            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background: var(--secondary-blue); border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold;">${data.events ? data.events.length : 0}</div>
                    <div style="color: var(--text-light);">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--secondary-blue); border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold;">${data.achievements ? data.achievements.length : 0}</div>
                    <div style="color: var(--text-light);">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--secondary-blue); border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold;">${presentData.reduce((a, b) => a + b, 0)}</div>
                    <div style="color: var(--text-light);">–ü–æ—Å–µ—â–µ–Ω–∏–π</div>
                </div>
            </div>
        `;
        document.getElementById('progressChart').insertAdjacentHTML('afterend', statsHtml);
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
        document.getElementById('progressChart').innerHTML = '<p style="color: var(--text-light); text-align: center;">–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>';
    });
</script>

<script>
function switchRole(role) {
    fetch('/api/users/switch-role/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ role: role })
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200 && result.data.success) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            window.location.href = '/dashboard/';
        } else {
            alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–æ–ª–∏: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–æ–ª–∏');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.role-switch-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--primary-blue);
    border-radius: var(--border-radius);
    background: white;
    color: var(--primary-blue);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.role-switch-btn:hover {
    background: var(--primary-blue);
    color: white;
}

.role-switch-btn.active {
    background: var(--primary-blue);
    color: white;
}
</style>
{% endblock %}
