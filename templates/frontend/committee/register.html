{% extends 'base.html' %}
{% load static %}

{% block title %}Регистрация сотрудника спорткомитета - СпортБаш{% endblock %}

{% block content %}
<div class="container" style="max-width: 600px; margin: 3rem auto;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Регистрация сотрудника спорткомитета</h2>
        </div>
        <div class="card-body">
            <p style="color: var(--text-light); margin-bottom: 2rem;">
                Для регистрации в качестве сотрудника спорткомитета необходимо иметь специальный код регистрации, 
                выданный администрацией спорткомитета.
            </p>
            
            <form id="committeeRegisterForm">
                {% csrf_token %}
                <div id="messages"></div>
                
                <div class="form-group">
                    <label class="form-label" for="registrationCode">Код регистрации *</label>
                    <input type="text" class="form-control" id="registrationCode" name="registration_code" 
                           placeholder="Введите код регистрации" required 
                           style="text-transform: uppercase; font-family: monospace; font-size: 1.1rem; letter-spacing: 2px;">
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        Код регистрации выдается администрацией спорткомитета
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">
                    Зарегистрироваться как сотрудник спорткомитета
                </button>
            </form>
            
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                    Нет кода регистрации? Обратитесь в администрацию спорткомитета вашего города.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('committeeRegisterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messagesDiv = document.getElementById('messages');
    const code = document.getElementById('registrationCode').value.trim().toUpperCase();
    
    if (!code) {
        messagesDiv.innerHTML = '<div class="alert alert-error">Введите код регистрации</div>';
        return;
    }
    
    messagesDiv.innerHTML = '<div class="alert alert-info">Регистрация...</div>';
    
    fetch('/api/city-committee/register/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ registration_code: code })
    })
    .then(response => response.json().then(data => ({ status: response.status, data })))
    .then(result => {
        if (result.status === 201) {
            messagesDiv.innerHTML = '<div class="alert alert-success">Регистрация успешна! Перенаправление в личный кабинет...</div>';
            setTimeout(() => {
                window.location.href = '/dashboard/';
            }, 2000);
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + (result.data.error || 'Ошибка регистрации') + '</div>';
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">Произошла ошибка при регистрации</div>';
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
