{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∏ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-dashboard' %}" style="color: var(--primary-blue); text-decoration: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        </a>
    </div>
    
    <h1>üìã –ó–∞—è–≤–∫–∏ –Ω–∞ —Å–≤—è–∑—å —Ä–æ–¥–∏—Ç–µ–ª—å-—Ä–µ–±—ë–Ω–æ–∫</h1>
    
    <div id="requestsContainer">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function loadRequests() {
    fetch('/api/parents/requests/')
        .then(response => response.json())
        .then(data => {
            renderRequests(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
            document.getElementById('requestsContainer').innerHTML = 
                '<div class="card"><div class="card-body"><p style="color: var(--error-color);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫.</p></div></div>';
        });
}

function renderRequests(data) {
    const container = document.getElementById('requestsContainer');
    
    let html = '';
    
    // –ó–∞—è–≤–∫–∏, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Ä–æ–¥–∏—Ç–µ–ª—å
    if (data.as_parent && data.as_parent.length > 0) {
        html += `
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">–ú–æ–∏ –∑–∞—è–≤–∫–∏ (–∫–∞–∫ —Ä–æ–¥–∏—Ç–µ–ª—å)</h2>
                </div>
                <div class="card-body">
                    ${data.as_parent.map(req => `
                        <div class="card" style="margin-bottom: 1rem; background: var(--secondary-blue);">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="margin-bottom: 0.5rem;">${escapeHtml(req.child_name)}</h3>
                                        <p style="color: var(--text-light); font-size: 0.9rem;">
                                            –°—Ç–∞—Ç—É—Å: ${req.status === 'pending_child' ? '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Ä–µ–±—ë–Ω–∫–∞' : 
                                                      req.status === 'pending_parent' ? '–û–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è' : 
                                                      req.status === 'confirmed' ? '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'}
                                        </p>
                                    </div>
                                    ${req.status === 'pending_parent' ? `
                                    <div>
                                        <button class="btn btn-primary" onclick="confirmRequest(${req.id})" style="margin-right: 0.5rem;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                                        <button class="btn btn-secondary" onclick="rejectRequest(${req.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // –ó–∞—è–≤–∫–∏, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Ä–µ–±—ë–Ω–æ–∫
    if (data.as_child && data.as_child.length > 0) {
        html += `
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">–ó–∞—è–≤–∫–∏ –∫–æ –º–Ω–µ (–∫–∞–∫ —Ä–µ–±—ë–Ω–æ–∫)</h2>
                </div>
                <div class="card-body">
                    ${data.as_child.map(req => `
                        <div class="card" style="margin-bottom: 1rem; background: var(--secondary-blue);">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="margin-bottom: 0.5rem;">${escapeHtml(req.parent_name)}</h3>
                                        <p style="color: var(--text-light); font-size: 0.9rem;">
                                            –°—Ç–∞—Ç—É—Å: ${req.status === 'pending_child' ? '–û–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è' : 
                                                      req.status === 'pending_parent' ? '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è' : 
                                                      req.status === 'confirmed' ? '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'}
                                        </p>
                                    </div>
                                    ${req.status === 'pending_child' ? `
                                    <div>
                                        <button class="btn btn-primary" onclick="confirmRequest(${req.id})" style="margin-right: 0.5rem;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                                        <button class="btn btn-secondary" onclick="rejectRequest(${req.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    if (!html) {
        html = '<div class="card"><div class="card-body"><p style="color: var(--text-light);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫.</p></div></div>';
    }
    
    container.innerHTML = html;
}

function confirmRequest(linkId) {
    if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞—è–≤–∫—É?')) {
        return;
    }
    
    fetch(`/api/parents/requests/${linkId}/confirm/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (response.ok) {
            alert(data.message || '–ó–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞');
            loadRequests();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–∫–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏');
    });
}

function rejectRequest(linkId) {
    if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) {
        return;
    }
    
    fetch(`/api/parents/requests/${linkId}/reject/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200) {
            alert(result.data.message || '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
            loadRequests();
        } else {
            alert(result.data.error || '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏');
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadRequests();
});
</script>
{% endblock %}
