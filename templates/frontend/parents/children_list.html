{% extends 'base.html' %}
{% load static %}
{% load role_names %}

{% block title %}–ú–æ–∏ –¥–µ—Ç–∏ - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-dashboard' %}" style="color: var(--primary-blue); text-decoration: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        </a>
    </div>
    
    <h1>üë®‚Äçüë©‚Äçüëß –ú–æ–∏ –¥–µ—Ç–∏</h1>
    
    <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-body">
            <button class="btn btn-primary" onclick="showAddChildModal()">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</button>
            <a href="{% url 'frontend-parent-requests' %}" class="btn btn-secondary" style="margin-left: 0.5rem;">–ó–∞—è–≤–∫–∏</a>
        </div>
    </div>
    
    <div id="childrenList">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞ -->
    <div id="addChildModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</h3>
                <span class="close" onclick="closeAddChildModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-light);">
                    –í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ä–æ–ª–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –≤–∞—à–µ–≥–æ —Ä–µ–±—ë–Ω–∫–∞. 
                    –≠—Ç–æ—Ç ID –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞.
                </p>
                <div class="form-group">
                    <label class="form-label" for="childRoleId">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ä–æ–ª–∏ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞</label>
                    <input type="text" class="form-control" id="childRoleId" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A1B2C3D4" maxlength="8" style="text-transform: uppercase;">
                    <small style="color: var(--text-light);">ID —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 8 —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)</small>
                </div>
                <div id="addChildMessages" style="margin-top: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddChildModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="sendChildRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–µ–π
function loadChildren() {
    fetch('/api/parents/children/')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('childrenList');
            if (data.length === 0) {
                container.innerHTML = '<div class="card"><div class="card-body"><p style="color: var(--text-light);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–µ—Ç–µ–π.</p></div></div>';
                return;
            }
            
            let html = '<div class="grid grid-2" style="gap: 1rem;">';
            data.forEach(child => {
                html += `
                    <div class="card" style="cursor: pointer;" onclick="window.location.href='/parents/children/${child.id}/'">
                        <div class="card-body">
                            <h3 style="margin-bottom: 0.5rem;">
                                ${child.role_unique_id ? `<a href="/profiles/${child.role_unique_id}/" onclick="event.stopPropagation();" style="color: var(--primary-blue); text-decoration: none;">${escapeHtml(child.full_name || child.first_name + ' ' + child.last_name)}</a>` : escapeHtml(child.full_name || child.first_name + ' ' + child.last_name)}
                            </h3>
                            <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                                ${child.main_sport_name ? 'üèÉ ' + escapeHtml(child.main_sport_name) : '–°–ø–æ—Ä—Ç –Ω–µ —É–∫–∞–∑–∞–Ω'}
                            </p>
                            <p style="color: var(--text-light); font-size: 0.9rem;">
                                ${child.organization_name && child.organization_name.length > 0 ? 'üè¢ ' + escapeHtml(child.organization_name[0]) : '–ù–µ –∑–∞–ø–∏—Å–∞–Ω –≤ —Å–µ–∫—Ü–∏—é'}
                            </p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–µ–π:', error);
            document.getElementById('childrenList').innerHTML = 
                '<div class="card"><div class="card-body"><p style="color: var(--error-color);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–µ–π.</p></div></div>';
        });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞
function showAddChildModal() {
    document.getElementById('addChildModal').style.display = 'block';
    document.getElementById('childRoleId').value = '';
    document.getElementById('addChildMessages').innerHTML = '';
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeAddChildModal() {
    document.getElementById('addChildModal').style.display = 'none';
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞
function sendChildRequest() {
    const roleId = document.getElementById('childRoleId').value.trim().toUpperCase();
    const messagesDiv = document.getElementById('addChildMessages');
    
    if (!roleId || roleId.length !== 8) {
        messagesDiv.innerHTML = '<div class="alert alert-error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID (8 —Å–∏–º–≤–æ–ª–æ–≤)</div>';
        return;
    }
    
    messagesDiv.innerHTML = '<div class="alert alert-info">–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏...</div>';
    
    fetch('/api/parents/children/request/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ role_unique_id: roleId })
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data }));
    })
    .then(result => {
        if (result.status === 200 || result.status === 201) {
            messagesDiv.innerHTML = '<div class="alert alert-success">' + (result.data.message || '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞') + '</div>';
            setTimeout(() => {
                closeAddChildModal();
                loadChildren();
            }, 2000);
        } else {
            messagesDiv.innerHTML = '<div class="alert alert-error">' + (result.data.error || result.data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏') + '</div>';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML = '<div class="alert alert-error">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏</div>';
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadChildren();
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('addChildModal');
    if (event.target == modal) {
        closeAddChildModal();
    }
}
</script>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.close {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-light);
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: var(--text-color);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}
</style>
{% endblock %}
