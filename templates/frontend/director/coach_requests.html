{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç—É - –°–ø–æ—Ä—Ç–ë–∞—à{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 1rem;">
        <a href="{% url 'frontend-dashboard' %}" style="color: var(--primary-blue); text-decoration: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        </a>
    </div>
    
    <h1>üìù –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç—É</h1>
    <p style="color: var(--text-light); margin-bottom: 2rem;">
        –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –æ—Ç —Ç—Ä–µ–Ω–µ—Ä–æ–≤, –∂–µ–ª–∞—é—â–∏—Ö —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.
    </p>
    
    <div id="requestsList">
        <div class="loading" style="margin: 2rem auto; display: block;"></div>
    </div>
</div>

<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫
function loadRequests() {
    fetch('/api/coaches/requests/', {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => response.json())
        .then(data => {
            renderRequests(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            document.getElementById('requestsList').innerHTML = 
                '<p style="color: var(--text-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>';
        });
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞—è–≤–æ–∫
function renderRequests(requests) {
    const container = document.getElementById('requestsList');
    
    if (!requests || requests.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</p>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
    requests.forEach(req => {
        const ageLevels = req.age_levels ? req.age_levels.map(al => al.name).join(', ') : '–ù–µ —É–∫–∞–∑–∞–Ω—ã';
        html += `
            <div class="card">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">${escapeHtml(req.coach_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}</h3>
                            <p style="color: var(--text-light); margin-bottom: 0.5rem;">
                                <strong>Email:</strong> ${escapeHtml(req.coach_email || '–ù–µ —É–∫–∞–∑–∞–Ω')}
                            </p>
                            ${req.coach_phone ? `<p style="color: var(--text-light); margin-bottom: 0.5rem;"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${escapeHtml(req.coach_phone)}</p>` : ''}
                            <p style="margin-bottom: 0.5rem;">
                                <strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</strong> ${escapeHtml(req.specialization_name || '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}
                            </p>
                            <p style="margin-bottom: 0.5rem;">
                                <strong>–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã:</strong> ${ageLevels}
                            </p>
                            ${req.message ? `<p style="margin-bottom: 0.5rem;"><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${escapeHtml(req.message)}</p>` : ''}
                            <p style="color: var(--text-light); font-size: 0.9rem;">
                                –ü–æ–¥–∞–Ω–∞: ${new Date(req.created_at).toLocaleString('ru-RU')}
                            </p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="approveRequest(${req.id})">–û–¥–æ–±—Ä–∏—Ç—å</button>
                        <button class="btn btn-danger" onclick="rejectRequest(${req.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// –û–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
function approveRequest(requestId) {
    if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É —ç—Ç–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞?')) {
        return;
    }
    
    fetch(`/api/coaches/requests/${requestId}/approve/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            return response.json().then(data => ({ status: response.status, data }));
        })
        .then(result => {
            if (result.status === 200) {
                alert('–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!');
                loadRequests();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏');
        });
}

// –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
function rejectRequest(requestId) {
    const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):');
    if (reason === null) return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª
    
    fetch(`/api/coaches/requests/${requestId}/reject/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            rejected_reason: reason || ''
        })
    })
        .then(response => {
            return response.json().then(data => ({ status: response.status, data }));
        })
        .then(result => {
            if (result.status === 200) {
                alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
                loadRequests();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (result.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏');
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadRequests();
});

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
