# Система аккаунтов

## Общая концепция

СпортБаш использует **единую систему аккаунтов** с поддержкой **мультиролевой модели**. Один пользователь может иметь несколько ролей, но все они привязаны к одному базовому аккаунту.

---

## 1. Базовый аккаунт (CustomUser)

### Структура

Базовый аккаунт содержит **общие данные**, которые используются всеми ролями:

```python
CustomUser:
  - email (уникальный)
  - phone (уникальный, опционально)
  - telegram_id (уникальный, опционально)
  - vk_id (уникальный, опционально)
  
  # Общие данные (синхронизируются)
  - first_name (Имя)
  - last_name (Фамилия)
  - patronymic (Отчество)
  - full_name (вычисляемое: "Фамилия Имя Отчество")
  - photo (Фото профиля)
  - birth_date (Дата рождения, опционально)
  - gender (Пол, опционально)
  - city (Город, строка)
  
  # Системные поля
  - is_active (Активен ли аккаунт)
  - is_staff (Доступ к админке Django)
  - is_superuser (Суперпользователь)
  - created_at, updated_at (Временные метки)
```

### Особенности

1. **Единый идентификатор:** Все роли одного пользователя имеют один `user_id`
2. **Синхронизация данных:** Изменение общих данных отражается во всех ролях
3. **Множественные способы входа:** Email, телефон, Telegram, ВКонтакте
4. **Безопасность:** Все способы входа привязаны к одному аккаунту

---

## 2. Система ролей (UserRole)

### Структура

Каждая роль - это отдельная запись в таблице `UserRole`:

```python
UserRole:
  - user (ForeignKey → CustomUser)
  - role (ChoiceField: athlete, parent, coach, director, etc.)
  - is_active (Активна ли роль)
  - unique_id (Уникальный 8-символьный ID для связи)
  - created_at, updated_at
```

### Доступные роли

1. **athlete** (Спортсмен) - выбирается вручную
2. **parent** (Родитель) - создаётся автоматически при добавлении ребёнка
3. **coach** (Тренер) - выбирается вручную или назначается директором
4. **director** (Директор) - создаётся автоматически при создании организации
5. **organization** (Организация) - синоним director
6. **committee_staff** (Сотрудник спорткомитета) - назначается админом
7. **moderator** (Модератор) - назначается админом
8. **admin_rb** (Админ РБ) - назначается админом

### Уникальный ID роли

- **Формат:** 8 символов (буквы и цифры)
- **Генерация:** Автоматически при создании роли
- **Назначение:** Связь родителя с ребёнком, идентификация роли
- **Пример:** `ABC12345`, `XYZ98765`

---

## 3. Профили ролей

### 3.1. Профиль спортсмена (AthleteProfile)

```python
AthleteProfile:
  - user (OneToOne → CustomUser)
  - user_role (ForeignKey → UserRole)
  - main_sport (ForeignKey → Sport)
  - city (ForeignKey → City, синхронизируется с user.city)
  - health_group (ChoiceField: I, II, III)
  - goals (ArrayField: ["Соревнования", "ЗОЖ"])
  - medical_info (ForeignKey → MedicalInfo)
  - additional_sports (ManyToMany → Sport через AthleteSpecialization)
```

**Специфичные данные:**
- Спортивная специализация
- Медицинские данные (зашифрованы)
- Дополнительные виды спорта
- Цели занятий спортом

### 3.2. Профиль тренера (CoachProfile)

```python
CoachProfile:
  - user (OneToOne → CustomUser)
  - user_role (ForeignKey → UserRole)
  - specialization (ForeignKey → Sport)
  - city (ForeignKey → City, синхронизируется с user.city)
  - experience_years (IntegerField)
  - education (TextField)
  - bio (TextField)
  - phone (CharField)
  - telegram (CharField)
```

**Специфичные данные:**
- Специализация
- Опыт работы
- Образование
- Биография
- Контакты

### 3.3. Профиль родителя (ParentProfile)

```python
ParentProfile:
  - user (OneToOne → CustomUser)
  - user_role (ForeignKey → UserRole)
  - children (ManyToMany → AthleteProfile через ParentChildLink)
```

**Специфичные данные:**
- Связи с детьми (через ParentChildLink)
- Статус связи (pending, confirmed, rejected)

### 3.4. Профиль директора (Director)

```python
Director:
  - user (ForeignKey → CustomUser)
  - organization (ForeignKey → Organization)
  - user_role (ForeignKey → UserRole)
```

**Специфичные данные:**
- Связь с организацией
- Права управления организацией

---

## 4. Гостевой аккаунт

### Определение

Гостевой аккаунт - это **неавторизованный пользователь**, который может просматривать публичную информацию, но не может выполнять действия, требующие авторизации.

### Доступные функции

#### 4.1. Просмотр организаций
- **URL:** `/organizations/`
- **Доступно:**
  - Просмотр списка организаций
  - Фильтрация по городу и виду спорта
  - Просмотр карты с организациями
  - Детальная информация об организации:
    - Название, тип, адрес
    - Секции и группы
    - Тренеры
    - Расписание групп
    - Карта с расположением

- **Недоступно:**
  - Подача заявки на вступление
  - Создание организации
  - Редактирование данных

#### 4.2. Просмотр мероприятий
- **URL:** `/events/`
- **Доступно:**
  - Просмотр списка мероприятий
  - Фильтрация по виду спорта, городу, дате
  - Детальная информация о мероприятии:
    - Описание
    - Дата и место проведения
    - Возрастные группы
    - Требования к участникам

- **Недоступно:**
  - Регистрация на мероприятие
  - Просмотр списка участников
  - Загрузка результатов

#### 4.3. Главная страница
- **URL:** `/`
- **Доступно:**
  - Информация о платформе
  - Описание возможностей
  - Быстрые ссылки на организации и мероприятия
  - Кнопки входа и регистрации

#### 4.4. Регистрация и вход
- **URL:** `/register/`, `/login/`
- **Доступно:**
  - Регистрация нового аккаунта
  - Вход через Email
  - Вход через ВКонтакте
  - Вход через Telegram

### Ограничения гостевого аккаунта

1. **Нет доступа к личному кабинету**
2. **Нет возможности создавать/редактировать данные**
3. **Нет доступа к приватной информации**
4. **Нет возможности регистрироваться на мероприятия**
5. **Нет доступа к статистике и аналитике**

### Переход к авторизованному аккаунту

При попытке выполнить действие, требующее авторизации:
1. Пользователь перенаправляется на страницу входа
2. После входа возвращается к запрошенному действию
3. Или перенаправляется в личный кабинет

---

## 5. Мультиаккаунтность

### Принцип работы

Один пользователь может иметь **до 4 ролей одновременно**:
- Спортсмен
- Родитель
- Тренер
- Директор

### Создание новых ролей

#### 5.1. Выбор роли вручную
**Доступные для выбора:**
- `athlete` (Спортсмен)
- `coach` (Тренер)

**Процесс:**
1. Пользователь нажимает "Добавить роль" в личном кабинете
2. Выбирает роль из доступных
3. Подтверждает выбор
4. Если профиль для роли не создан → перенаправление на заполнение профиля
5. Если профиль создан → роль активируется

#### 5.2. Автоматическое создание ролей

**Роль "Родитель":**
- Создаётся автоматически при добавлении первого ребёнка
- Пользователь отправляет запрос на связь с ребёнком
- При подтверждении запроса создаётся `ParentProfile` и `UserRole(role='parent')`

**Роль "Директор":**
- Создаётся автоматически при создании организации
- После успешного создания организации создаётся `Director` и `UserRole(role='director')`
- Организация отправляется на модерацию

### Переключение между ролями

#### Механизм переключения

1. **Визуальное переключение:**
   - Блок с кнопками ролей в личном кабинете
   - Активная роль выделена
   - Нажатие на роль → переключение

2. **Техническое переключение:**
   ```javascript
   // Отправка запроса
   fetch('/api/users/switch-role/', {
     method: 'POST',
     headers: {
       'Content-Type': 'application/json',
       'X-CSRFToken': getCookie('csrftoken')
     },
     body: JSON.stringify({role: 'coach'})
   })
   ```

3. **Сохранение в сессии:**
   - Активная роль сохраняется в `request.session['active_role']`
   - При следующем запросе загружается соответствующий кабинет

4. **Редирект:**
   - После переключения → редирект на `/dashboard/`
   - Отображается кабинет выбранной роли

### Синхронизация данных

#### Общие данные (синхронизируются)
- **ФИО** (first_name, last_name, patronymic)
- **Фото** (photo)
- **Город** (city)
- **Дата рождения** (birth_date)
- **Пол** (gender)

**Механизм:**
- Хранятся в `CustomUser`
- Изменение в одном кабинете → обновление во всех
- API: `/api/users/basic-data/` (GET/PATCH)

#### Специфичные данные (не синхронизируются)
- **Спортсмен:** main_sport, health_group, medical_info
- **Тренер:** specialization, experience_years, education
- **Родитель:** children (связи с детьми)
- **Директор:** organizations (созданные организации)

**Механизм:**
- Хранятся в профилях ролей
- Изменение влияет только на конкретную роль
- API: `/api/athletes/profile/`, `/api/coaches/profile/`, etc.

---

## 6. Способы входа

### 6.1. Email + Пароль

**Процесс:**
1. Пользователь вводит email и пароль
2. Система проверяет учётные данные
3. Создаётся сессия
4. Возвращается информация о пользователе и ролях

**API:** `POST /api/auth/login/`

### 6.2. ВКонтакте (OAuth 2.0)

**Процесс:**
1. Пользователь нажимает "Войти через ВКонтакте"
2. Перенаправление на VK OAuth
3. Пользователь разрешает доступ
4. VK возвращает код авторизации
5. Система обменивает код на access_token
6. Получает данные пользователя из VK API
7. Создаёт или находит аккаунт по `vk_id`
8. Создаётся сессия

**API:** `POST /api/auth/vk/`

**Создание согласия:**
- При первом входе автоматически создаётся `Consent(type='personal_data', granted=True)`

### 6.3. Telegram (Mini App)

**Процесс:**
1. Пользователь открывает Mini App в Telegram
2. Telegram передаёт `initData` в приложение
3. Система проверяет подпись `initData`
4. Извлекает данные пользователя (user_id, username, etc.)
5. Создаёт или находит аккаунт по `telegram_id`
6. Создаётся сессия

**API:** `POST /api/auth/telegram/`

**Безопасность:**
- Проверка HMAC-SHA-256 подписи
- Валидация `auth_date` (не старше 24 часов)
- Проверка домена

**Создание согласия:**
- При первом входе автоматически создаётся `Consent(type='personal_data', granted=True)`

### 6.4. Привязка способов входа

**Принцип:**
- Все способы входа привязываются к одному `CustomUser`
- Один пользователь может войти любым из привязанных способов
- При первом входе через новый способ → привязка к существующему аккаунту (если email совпадает)

**Управление:**
- В будущем: раздел "Способы входа" в профиле
- Добавление/удаление способов входа
- Привязка существующих аккаунтов

---

## 7. Уникальный ID роли

### Назначение

Уникальный ID используется для:
- **Связи родителя с ребёнком:** Родитель вводит ID ребёнка для запроса связи
- **Идентификации роли:** Каждая роль имеет уникальный идентификатор
- **Безопасность:** Не раскрывает личную информацию пользователя

### Формат

- **Длина:** 8 символов
- **Символы:** Заглавные буквы (A-Z) и цифры (0-9)
- **Примеры:** `ABC12345`, `XYZ98765`, `DEF98765`

### Генерация

```python
import random
import string

def generate_unique_id():
    while True:
        unique_id = ''.join(random.choices(
            string.ascii_uppercase + string.digits, 
            k=8
        ))
        if not UserRole.objects.filter(unique_id=unique_id).exists():
            return unique_id
```

### Использование

**Для спортсмена:**
- Отображается в личном кабинете
- Кнопка копирования ID
- Родитель использует этот ID для запроса связи

**Для родителя:**
- Отображается в личном кабинете
- Используется детьми для запроса связи с родителем

**API:**
- `GET /api/users/my-role-id/` - получить ID активной роли
- `GET /api/parents/my-role-id/` - получить ID роли родителя

---

## 8. Согласие на обработку ПДн

### Требования ФЗ-152

Согласно Федеральному закону №152-ФЗ "О персональных данных", необходимо:
- Получать явное согласие на обработку ПДн
- Хранить согласие с датой и временем
- Предоставлять возможность отозвать согласие

### Реализация

```python
Consent:
  - user (ForeignKey → CustomUser)
  - type (ChoiceField: 'personal_data', 'marketing', etc.)
  - granted (BooleanField)
  - granted_at (DateTimeField)
  - revoked_at (DateTimeField, опционально)
```

### Типы согласий

1. **personal_data** - Обработка персональных данных
   - Создаётся автоматически при регистрации
   - Требуется для работы платформы

2. **marketing** - Маркетинговые рассылки (будущее)
   - Опционально
   - Для отправки рекламных материалов

### Процесс получения согласия

1. **При регистрации:**
   - Пользователь регистрируется
   - Автоматически создаётся `Consent(type='personal_data', granted=True)`

2. **При входе через соцсети:**
   - Автоматически создаётся согласие
   - Если данных недостаточно → запрос на заполнение профиля

3. **Управление согласиями:**
   - API: `GET /api/core/consents/`
   - API: `POST /api/core/consents/update/`
   - В будущем: интерфейс в личном кабинете

---

## 9. Безопасность аккаунта

### Защита данных

1. **Шифрование:**
   - Медицинские данные зашифрованы (AES-256)
   - Пароли хешируются (Django default)

2. **Аутентификация:**
   - Session-based для веб-интерфейса
   - JWT для мобильных приложений
   - CSRF защита для всех POST запросов

3. **Аудит:**
   - Все действия логируются
   - Доступ к логам только для админов

### Управление аккаунтом

1. **Активация/деактивация:**
   - Только администратором
   - Деактивированный аккаунт не может войти

2. **Удаление аккаунта:**
   - В будущем: функция удаления аккаунта
   - Удаление всех связанных данных
   - Соответствие ФЗ-152

---

## 10. Примеры использования

### Пример 1: Пользователь с несколькими ролями

```
Пользователь: Иванов Иван Иванович
├── Email: ivan@example.com
├── Роли:
│   ├── Спортсмен (ID: ABC12345)
│   │   └── Профиль: Футбол, группа здоровья I
│   ├── Тренер (ID: XYZ98765)
│   │   └── Профиль: Специализация - Футбол, опыт 10 лет
│   └── Родитель (ID: DEF45678)
│       └── Дети: [Спортсмен Петров Пётр]
└── Общие данные: ФИО, фото, город синхронизируются
```

### Пример 2: Связь родителя с ребёнком

```
1. Ребёнок (Спортсмен):
   - Уникальный ID: ABC12345
   - Отображается в личном кабинете

2. Родитель:
   - Вводит ID: ABC12345
   - Отправляет запрос на связь

3. Система:
   - Создаёт ParentChildLink(status='pending_child')
   - Отправляет уведомление ребёнку

4. Ребёнок:
   - Подтверждает запрос
   - ParentChildLink(status='confirmed')

5. Родитель:
   - Получает доступ к данным ребёнка
   - Автоматически создаётся роль "Родитель"
```

### Пример 3: Автоматическое создание роли директора

```
1. Пользователь создаёт организацию:
   - Заполняет форму
   - Загружает документы
   - Отправляет на модерацию

2. Система:
   - Создаёт Organization(status='pending')
   - Создаёт UserRole(role='director')
   - Создаёт Director(user=user, organization=org)

3. После модерации:
   - Organization(status='approved')
   - Директор получает полный доступ к управлению
```

---

## 11. API для работы с аккаунтом

### Получить все роли
`GET /api/users/roles/`

### Выбрать роль
`POST /api/users/select-role/`

### Переключить роль
`POST /api/users/switch-role/`

### Получить/Обновить общие данные
`GET/PATCH /api/users/basic-data/`

### Получить ID активной роли
`GET /api/users/my-role-id/`

---

## 12. Рекомендации

### Для пользователей

1. **Используйте один аккаунт** для всех ролей
2. **Привязывайте несколько способов входа** для удобства
3. **Храните уникальный ID** роли для связи с родителями/детьми
4. **Регулярно обновляйте общие данные** - они синхронизируются везде

### Для разработчиков

1. **Всегда проверяйте активную роль** из сессии
2. **Используйте общие данные** из `CustomUser`, а не из профилей
3. **Синхронизируйте город** между `user.city` и профилями
4. **Проверяйте права доступа** перед выполнением действий
